function p(...i){if(i.length===1&&i[0]instanceof Uint8Array)return i[0];let e=i.reduce((n,a)=>n+a.length,0),t=new Uint8Array(e),r=0;for(let n of i)t.set(n,r),r+=n.length;return t}function O(i,e){let t=i.length;if(t!==e.length)return!1;for(let r=0;r<t;r++)if(i[r]!==e[r])return!1;return!0}var rt="\xB7\xB7 ";var Nt=new TextEncoder,Yt=new TextDecoder,N=class{offset;dataView;data;comments;indents;indent;constructor(e){this.offset=0,this.data=typeof e=="number"?new Uint8Array(e):e,this.dataView=new DataView(this.data.buffer,this.data.byteOffset,this.data.byteLength),this.comments={},this.indents={},this.indent=0}extend(e){let t=typeof e=="number"?new Uint8Array(e):e;this.data=p(this.data,t),this.dataView=new DataView(this.data.buffer,this.data.byteOffset,this.data.byteLength)}remaining(){return this.data.length-this.offset}subarray(e){return this.data.subarray(this.offset,this.offset+=e)}skip(e,t){return this.offset+=e,t&&this.comment(t),this}comment(e,t=this.offset){throw new Error("No comments should be emitted outside of chatty mode")}readBytes(e){return this.data.slice(this.offset,this.offset+=e)}readUTF8String(e){let t=this.subarray(e);return Yt.decode(t)}readUTF8StringNullTerminated(){let e=this.offset;for(;this.data[e]!==0;)e++;let t=this.readUTF8String(e-this.offset);return this.expectUint8(0,"end of string"),t}readUint8(e){let t=this.dataView.getUint8(this.offset);return this.offset+=1,t}readUint16(e){let t=this.dataView.getUint16(this.offset);return this.offset+=2,t}readUint24(e){let t=this.readUint8(),r=this.readUint16();return(t<<16)+r}readUint32(e){let t=this.dataView.getUint32(this.offset);return this.offset+=4,t}expectBytes(e,t){let r=this.readBytes(e.length);if(!O(r,e))throw new Error("Unexpected bytes")}expectUint8(e,t){let r=this.readUint8();if(r!==e)throw new Error(`Expected ${e}, got ${r}`)}expectUint16(e,t){let r=this.readUint16();if(r!==e)throw new Error(`Expected ${e}, got ${r}`)}expectUint24(e,t){let r=this.readUint24();if(r!==e)throw new Error(`Expected ${e}, got ${r}`)}expectUint32(e,t){let r=this.readUint32();if(r!==e)throw new Error(`Expected ${e}, got ${r}`)}expectLength(e,t=1){let r=this.offset,n=r+e;if(n>this.data.length)throw new Error("Expected length exceeds remaining data length");return this.indent+=t,this.indents[r]=this.indent,[()=>{if(this.indent-=t,this.indents[this.offset]=this.indent,this.offset!==n)throw new Error(`${e} bytes expected but ${this.offset-r} read`)},()=>n-this.offset]}expectLengthUint8(e){let t=this.readUint8();return this.expectLength(t)}expectLengthUint16(e){let t=this.readUint16();return this.expectLength(t)}expectLengthUint24(e){let t=this.readUint24();return this.expectLength(t)}expectLengthUint32(e){let t=this.readUint32();return this.expectLength(t)}expectLengthUint8Incl(e){let t=this.readUint8();return this.expectLength(t-1)}expectLengthUint16Incl(e){let t=this.readUint16();return this.expectLength(t-2)}expectLengthUint24Incl(e){let t=this.readUint24();return this.expectLength(t-3)}expectLengthUint32Incl(e){let t=this.readUint32();return this.expectLength(t-4)}writeBytes(e){return this.data.set(e,this.offset),this.offset+=e.length,this}writeUTF8String(e){let t=Nt.encode(e);return this.writeBytes(t),this}writeUTF8StringNullTerminated(e){let t=Nt.encode(e);return this.writeBytes(t),this.writeUint8(0),this}writeUint8(e,t){return this.dataView.setUint8(this.offset,e),this.offset+=1,this}writeUint16(e,t){return this.dataView.setUint16(this.offset,e),this.offset+=2,this}writeUint24(e,t){return this.writeUint8((e&16711680)>>16),this.writeUint16(e&65535,t),this}writeUint32(e,t){return this.dataView.setUint32(this.offset,e),this.offset+=4,this}_writeLengthGeneric(e,t,r){let n=this.offset;this.offset+=e;let a=this.offset;return this.indent+=1,this.indents[a]=this.indent,()=>{let c=this.offset-(t?n:a);if(e===1)this.dataView.setUint8(n,c);else if(e===2)this.dataView.setUint16(n,c);else if(e===3)this.dataView.setUint8(n,(c&16711680)>>16),this.dataView.setUint16(n+1,c&65535);else if(e===4)this.dataView.setUint32(n,c);else throw new Error(`Invalid length for length field: ${e}`);this.indent-=1,this.indents[this.offset]=this.indent}}writeLengthUint8(e){return this._writeLengthGeneric(1,!1,e)}writeLengthUint16(e){return this._writeLengthGeneric(2,!1,e)}writeLengthUint24(e){return this._writeLengthGeneric(3,!1,e)}writeLengthUint32(e){return this._writeLengthGeneric(4,!1,e)}writeLengthUint8Incl(e){return this._writeLengthGeneric(1,!0,e)}writeLengthUint16Incl(e){return this._writeLengthGeneric(2,!0,e)}writeLengthUint24Incl(e){return this._writeLengthGeneric(3,!0,e)}writeLengthUint32Incl(e){return this._writeLengthGeneric(4,!0,e)}array(){return this.data.subarray(0,this.offset)}commentedString(e=!1){let t=this.indents[0]!==void 0?rt.repeat(this.indents[0]):"",r=this.indents[0]??0,n=e?this.data.length:this.offset;for(let a=0;a<n;a++){t+=this.data[a].toString(16).padStart(2,"0")+" ";let c=this.comments[a+1];this.indents[a+1]!==void 0&&(r=this.indents[a+1]),c&&(t+=` ${c}
${rt.repeat(r)}`)}return t}};function St(i,e,t,r=!0){let n=new N(1024);n.writeUint8(22,0),n.writeUint16(769,0);let a=n.writeLengthUint16();n.writeUint8(1,0);let c=n.writeLengthUint24();n.writeUint16(771,0),crypto.getRandomValues(n.subarray(32));let s=n.writeLengthUint8(0);n.writeBytes(t),s();let o=n.writeLengthUint16(0);n.writeUint16(4865,0),o();let h=n.writeLengthUint8(0);n.writeUint8(0,0),h();let y=n.writeLengthUint16(0);if(r){n.writeUint16(0,0);let q=n.writeLengthUint16(0),z=n.writeLengthUint16(0);n.writeUint8(0,0);let T=n.writeLengthUint16(0);n.writeUTF8String(i),T(),z(),q()}n.writeUint16(11,0);let d=n.writeLengthUint16(0),g=n.writeLengthUint8(0);n.writeUint8(0,0),g(),d(),n.writeUint16(10,0);let m=n.writeLengthUint16(0),A=n.writeLengthUint16(0);n.writeUint16(23,0),A(),m(),n.writeUint16(13,0);let L=n.writeLengthUint16(0),f=n.writeLengthUint16(0);n.writeUint16(1027,0),n.writeUint16(2052,0),f(),L(),n.writeUint16(43,0);let u=n.writeLengthUint16(0),x=n.writeLengthUint8(0);n.writeUint16(772,0),x(),u(),n.writeUint16(51,0);let D=n.writeLengthUint16(0),$=n.writeLengthUint16(0);n.writeUint16(23,0);let j=n.writeLengthUint16(0);return n.writeBytes(new Uint8Array(e)),j(),$(),D(),y(),c(),a(),n}function K(i,e=""){return[...i].map(t=>t.toString(16).padStart(2,"0")).join(e)}function Ut(i,e){let t,r,[n]=i.expectLength(i.remaining());i.expectUint8(2,0);let[a]=i.expectLengthUint24(0);i.expectUint16(771,0);let c=i.readBytes(32);if(O(c,[207,33,173,116,229,154,97,17,190,29,140,2,30,101,184,145,194,162,17,22,122,187,140,94,7,158,9,226,200,168,51,156]))throw new Error("Unexpected HelloRetryRequest");i.expectUint8(e.length,0),i.expectBytes(e,0),i.expectUint16(4865,0),i.expectUint8(0,0);let[s,o]=i.expectLengthUint16(0);for(;o()>0;){let h=i.readUint16(0),[y]=i.expectLengthUint16(0);if(h===43)i.expectUint16(772,0),r=!0;else if(h===51)i.expectUint16(23,0),i.expectUint16(65),t=i.readBytes(65);else throw new Error(`Unexpected extension 0x${K([h])}`);y()}if(s(),a(),n(),r!==!0)throw new Error("No TLS version provided");if(t===void 0)throw new Error("No key provided");return t}var ve=new RegExp(`  .+|^(${rt})+`,"gm");var it=1<<14,te=it+1+255;async function ht(i,e,t=it){let n=await i(5);if(n===void 0)return;if(n.length<5)throw new Error("TLS record header truncated");let a=new N(n),c=a.readUint8();if(c<20||c>24)throw new Error(`Illegal TLS record type 0x${c.toString(16)}`);if(e!==void 0&&c!==e)throw new Error(`Unexpected TLS record type 0x${c.toString(16).padStart(2,"0")} (expected 0x${e.toString(16).padStart(2,"0")})`);a.expectUint16(771,"TLS record version 1.2 (middlebox compatibility)");let s=a.readUint16(0);if(s>t)throw new Error(`Record too long: ${s} bytes`);let o=await i(s);if(o===void 0||o.length<s)throw new Error("TLS record content truncated");return{headerData:n,header:a,type:c,length:s,content:o}}async function dt(i,e,t){let r=await ht(i,23,te);if(r===void 0)return;let n=new N(r.content),[a]=n.expectLength(n.remaining());n.skip(r.length-16,0),n.skip(16,0),a();let c=await e.process(r.content,16,r.headerData),s=c.length-1;for(;c[s]===0;)s-=1;if(s<0)throw new Error("Decrypted message has no record type indicator (all zeroes)");let o=c[s],h=c.subarray(0,s);if(!(o===21&&h.length===2&&h[0]===1&&h[1]===0)){if(o===22&&h[0]===4)return dt(i,e,t);if(t!==void 0&&o!==t)throw new Error(`Unexpected TLS record type 0x${o.toString(16).padStart(2,"0")} (expected 0x${t.toString(16).padStart(2,"0")})`);return h}}async function ee(i,e,t){let r=p(i,[t]),n=5,s=r.length+16,o=new N(n+s);o.writeUint8(23,0),o.writeUint16(771,0),o.writeUint16(s,`${s} bytes follow`);let[h]=o.expectLength(s),y=o.array(),d=await e.process(r,16,y);return o.writeBytes(d.subarray(0,d.length-16)),o.writeBytes(d.subarray(d.length-16)),h(),o.array()}async function At(i,e,t){let r=Math.ceil(i.length/it),n=[];for(let a=0;a<r;a++){let c=i.subarray(a*it,(a+1)*it),s=await ee(c,e,t);n.push(s)}return n}var l=crypto.subtle;var Ht=new TextEncoder;async function lt(i,e,t){let r=await l.importKey("raw",i,{name:"HMAC",hash:{name:`SHA-${t}`}},!1,["sign"]);var n=new Uint8Array(await l.sign("HMAC",r,e));return n}async function ne(i,e,t,r){let n=r>>3,a=Math.ceil(t/n),c=new Uint8Array(a*n),s=await l.importKey("raw",i,{name:"HMAC",hash:{name:`SHA-${r}`}},!1,["sign"]),o=new Uint8Array(0);for(let h=0;h<a;h++){let y=p(o,e,[h+1]),d=await l.sign("HMAC",s,y),g=new Uint8Array(d);c.set(g,n*h),o=g}return c.subarray(0,t)}var Rt=Ht.encode("tls13 ");async function S(i,e,t,r,n){let a=Ht.encode(e),c=p([(r&65280)>>8,r&255],[Rt.length+a.length],Rt,a,[t.length],t);return ne(i,c,r,n)}async function Kt(i,e,t,r,n){let a=r>>>3,c=new Uint8Array(a),s=await l.importKey("raw",i,{name:"ECDH",namedCurve:"P-256"},!1,[]),o=await l.deriveBits({name:"ECDH",public:s},e,256),h=new Uint8Array(o),y=await l.digest("SHA-256",t),d=new Uint8Array(y),g=await lt(new Uint8Array(1),c,r),m=await l.digest(`SHA-${r}`,new Uint8Array(0)),A=new Uint8Array(m),L=await S(g,"derived",A,a,r),f=await lt(L,h,r),u=await S(f,"c hs traffic",d,a,r),x=await S(f,"s hs traffic",d,a,r),D=await S(u,"key",new Uint8Array(0),n,r),$=await S(x,"key",new Uint8Array(0),n,r),j=await S(u,"iv",new Uint8Array(0),12,r),q=await S(x,"iv",new Uint8Array(0),12,r);return{serverHandshakeKey:$,serverHandshakeIV:q,clientHandshakeKey:D,clientHandshakeIV:j,handshakeSecret:f,clientSecret:u,serverSecret:x}}async function Dt(i,e,t,r){let n=t>>>3,a=new Uint8Array(n),c=await l.digest(`SHA-${t}`,new Uint8Array(0)),s=new Uint8Array(c),o=await S(i,"derived",s,n,t),h=await lt(o,a,t),y=await S(h,"c ap traffic",e,n,t),d=await S(h,"s ap traffic",e,n,t),g=await S(y,"key",new Uint8Array(0),r,t),m=await S(d,"key",new Uint8Array(0),r,t),A=await S(y,"iv",new Uint8Array(0),12,t),L=await S(d,"iv",new Uint8Array(0),12,t);return{serverApplicationKey:m,serverApplicationIV:L,clientApplicationKey:g,clientApplicationIV:A}}var re=2**31-1,Q=class{constructor(e,t,r){this.mode=e;this.key=t;this.initialIv=r}recordsProcessed=0;priorPromise=Promise.resolve(new Uint8Array);async process(e,t,r){let n=this.processUnsequenced(e,t,r);return this.priorPromise=this.priorPromise.then(()=>n)}async processUnsequenced(e,t,r){let n=this.recordsProcessed;if(n===re)throw new Error("Cannot encrypt/decrypt any more records");this.recordsProcessed+=1;let a=this.initialIv.slice(),c=a.length;a[c-1]^=n&255,a[c-2]^=n>>>8&255,a[c-3]^=n>>>16&255,a[c-4]^=n>>>24&255;let s=t<<3,o={name:"AES-GCM",iv:a,tagLength:s,additionalData:r},h=await l[this.mode](o,this.key,e);return new Uint8Array(h)}};function yt(i){return i>64&&i<91?i-65:i>96&&i<123?i-71:i>47&&i<58?i+4:i===43?62:i===47?63:i===61?64:void 0}function Tt(i){let e=i.length,t=0,r=0,n=64,a=64,c=64,s=64,o=new Uint8Array(e*.75);for(;t<e;)n=yt(i.charCodeAt(t++)),a=yt(i.charCodeAt(t++)),c=yt(i.charCodeAt(t++)),s=yt(i.charCodeAt(t++)),o[r++]=n<<2|a>>4,o[r++]=(a&15)<<4|c>>2,o[r++]=(c&3)<<6|s;let h=a===64?0:c===64?2:s===64?1:0;return o.subarray(0,r-h)}var _=class extends N{readASN1Length(e){let t=this.readUint8();if(t<128)return t;let r=t&127,n=0;if(r===1)return this.readUint8(n);if(r===2)return this.readUint16(n);if(r===3)return this.readUint24(n);if(r===4)return this.readUint32(n);throw new Error(`ASN.1 length fields are only supported up to 4 bytes (this one is ${r} bytes)`)}expectASN1Length(e){let t=this.readASN1Length(e);return this.expectLength(t)}readASN1OID(){let[e,t]=this.expectASN1Length(0),r=this.readUint8(),n=`${Math.floor(r/40)}.${r%40}`;for(;t()>0;){let a=0;for(;;){let c=this.readUint8();if(a<<=7,a+=c&127,c<128)break}n+=`.${a}`}return e(),n}readASN1Boolean(){let[e,t]=this.expectASN1Length(0),r=t();if(r!==1)throw new Error(`Boolean has weird length: ${r}`);let n=this.readUint8(),a;if(n===255)a=!0;else if(n===0)a=!1;else throw new Error(`Boolean has weird value: 0x${K([n])}`);return e(),a}readASN1UTCTime(){let[e,t]=this.expectASN1Length(0),n=this.readUTF8String(t()).match(/^(\d\d)(\d\d)(\d\d)(\d\d)(\d\d)(\d\d)Z$/);if(!n)throw new Error("Unrecognised ASN.1 UTC time format");let[,a,c,s,o,h,y]=n,d=parseInt(a,10),g=d+(d>=50?1900:2e3),m=new Date(`${g}-${c}-${s}T${o}:${h}:${y}Z`);return e(),m}readASN1BitString(){let[e,t]=this.expectASN1Length(0),r=this.readUint8(0),n=t(),a=this.readBytes(n);if(r>7)throw new Error(`Invalid right pad value: ${r}`);if(r>0){let c=8-r;for(let s=n-1;s>0;s--)a[s]=255&a[s-1]<<c|a[s]>>>r;a[0]=a[0]>>>r}return e(),a}};function mt(i,e=(r,n)=>n,t){return JSON.stringify(i,(n,a)=>e(n,typeof a!="object"||a===null||Array.isArray(a)?a:Object.fromEntries(Object.entries(a).sort(([c],[s])=>c<s?-1:c>s?1:0))),t)}var gt=1,tt=2,U=48,ie=49,W=6,se=19,ae=12,bt=23,ft=5,G=4,ut=3,$t=163,X=128;var ce={"2.5.4.6":"C","2.5.4.10":"O","2.5.4.11":"OU","2.5.4.3":"CN","2.5.4.7":"L","2.5.4.8":"ST","2.5.4.12":"T","2.5.4.42":"GN","2.5.4.43":"I","2.5.4.4":"SN","1.2.840.113549.1.9.1":"E-mail"};function qt(i){let{length:e}=i;if(e>4)throw new Error(`Bit string length ${e} would overflow JS bit operators`);let t=0,r=0;for(let n=i.length-1;n>=0;n--)t|=i[n]<<r,r+=8;return t}function Ct(i,e){let t={};i.expectUint8(U,0);let[r,n]=i.expectASN1Length(0);for(;n()>0;){i.expectUint8(ie,0);let[a]=i.expectASN1Length(0);i.expectUint8(U,0);let[c]=i.expectASN1Length(0);i.expectUint8(W,0);let s=i.readASN1OID(),o=ce[s]??s,h=i.readUint8();if(h!==se){if(h!==ae)throw new Error(`Unexpected item type in certificate ${e}: 0x${K([h])}`)}let[y,d]=i.expectASN1Length(0),g=i.readUTF8String(d());if(y(),c(),a(),t[o]!==void 0)throw new Error(`Duplicate OID ${o} in certificate ${e}`);t[o]=g}return r(),t}function Bt(i,e=0){let t=[],[r,n]=i.expectASN1Length(0);for(;n()>0;){let a=i.readUint8(0),[c,s]=i.expectASN1Length(0),o;a===(e|2)?o=i.readUTF8String(s()):o=i.readBytes(s()),t.push({name:o,type:a}),c()}return r(),t}function Ft(i){let e={"1.2.840.113549.1.1.1":{name:"RSAES-PKCS1-v1_5"},"1.2.840.113549.1.1.5":{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-1"}},"1.2.840.113549.1.1.11":{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},"1.2.840.113549.1.1.12":{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-384"}},"1.2.840.113549.1.1.13":{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-512"}},"1.2.840.113549.1.1.10":{name:"RSA-PSS"},"1.2.840.113549.1.1.7":{name:"RSA-OAEP"},"1.2.840.10045.2.1":{name:"ECDSA",hash:{name:"SHA-1"}},"1.2.840.10045.4.1":{name:"ECDSA",hash:{name:"SHA-1"}},"1.2.840.10045.4.3.2":{name:"ECDSA",hash:{name:"SHA-256"}},"1.2.840.10045.4.3.3":{name:"ECDSA",hash:{name:"SHA-384"}},"1.2.840.10045.4.3.4":{name:"ECDSA",hash:{name:"SHA-512"}},"1.3.133.16.840.63.0.2":{name:"ECDH",kdf:"SHA-1"},"1.3.132.1.11.1":{name:"ECDH",kdf:"SHA-256"},"1.3.132.1.11.2":{name:"ECDH",kdf:"SHA-384"},"1.3.132.1.11.3":{name:"ECDH",kdf:"SHA-512"},"2.16.840.1.101.3.4.1.2":{name:"AES-CBC",length:128},"2.16.840.1.101.3.4.1.22":{name:"AES-CBC",length:192},"2.16.840.1.101.3.4.1.42":{name:"AES-CBC",length:256},"2.16.840.1.101.3.4.1.6":{name:"AES-GCM",length:128},"2.16.840.1.101.3.4.1.26":{name:"AES-GCM",length:192},"2.16.840.1.101.3.4.1.46":{name:"AES-GCM",length:256},"2.16.840.1.101.3.4.1.4":{name:"AES-CFB",length:128},"2.16.840.1.101.3.4.1.24":{name:"AES-CFB",length:192},"2.16.840.1.101.3.4.1.44":{name:"AES-CFB",length:256},"2.16.840.1.101.3.4.1.5":{name:"AES-KW",length:128},"2.16.840.1.101.3.4.1.25":{name:"AES-KW",length:192},"2.16.840.1.101.3.4.1.45":{name:"AES-KW",length:256},"1.2.840.113549.2.7":{name:"HMAC",hash:{name:"SHA-1"}},"1.2.840.113549.2.9":{name:"HMAC",hash:{name:"SHA-256"}},"1.2.840.113549.2.10":{name:"HMAC",hash:{name:"SHA-384"}},"1.2.840.113549.2.11":{name:"HMAC",hash:{name:"SHA-512"}},"1.2.840.113549.1.9.16.3.5":{name:"DH"},"1.3.14.3.2.26":{name:"SHA-1"},"2.16.840.1.101.3.4.2.1":{name:"SHA-256"},"2.16.840.1.101.3.4.2.2":{name:"SHA-384"},"2.16.840.1.101.3.4.2.3":{name:"SHA-512"},"1.2.840.113549.1.5.12":{name:"PBKDF2"},"1.2.840.10045.3.1.7":{name:"P-256"},"1.3.132.0.34":{name:"P-384"},"1.3.132.0.35":{name:"P-521"}}[i];if(e===void 0)throw new Error(`Unsupported algorithm identifier: ${i}`);return e}function Ot(i,e=[]){return Object.values(i).forEach(t=>{typeof t=="string"?e=[...e,t]:e=Ot(t,e)}),e}function Pt(i){return Ot(i).join(" / ")}var oe=["digitalSignature","nonRepudiation","keyEncipherment","dataEncipherment","keyAgreement","keyCertSign","cRLSign","encipherOnly","decipherOnly"],P=class{serialNumber;algorithm;issuer;validityPeriod;subject;publicKey;signature;keyUsage;subjectAltNames;extKeyUsage;authorityKeyIdentifier;subjectKeyIdentifier;basicConstraints;signedData;static distinguishedNamesAreEqual(e,t){return mt(e)===mt(t)}static readableDN(e){return Object.entries(e).map(t=>t.join("=")).join(", ")}constructor(e){let t=e instanceof _?e:new _(e);t.expectUint8(U,0);let[r]=t.expectASN1Length(0),n=t.offset;t.expectUint8(U,0);let[a]=t.expectASN1Length(0);t.expectBytes([160,3,2,1,2],0),t.expectUint8(tt,0);let[c,s]=t.expectASN1Length(0);this.serialNumber=t.subarray(s()),c(),t.expectUint8(U,0);let[o,h]=t.expectASN1Length(0);t.expectUint8(W,0),this.algorithm=t.readASN1OID(),h()>0&&(t.expectUint8(ft,0),t.expectUint8(0,0)),o(),this.issuer=Ct(t,"issuer"),t.expectUint8(U,0);let[y]=t.expectASN1Length(0);t.expectUint8(bt,0);let d=t.readASN1UTCTime();t.expectUint8(bt,0);let g=t.readASN1UTCTime();this.validityPeriod={notBefore:d,notAfter:g},y(),this.subject=Ct(t,"subject");let m=t.offset;t.expectUint8(U,0);let[A]=t.expectASN1Length(0);t.expectUint8(U,0);let[L,f]=t.expectASN1Length(0),u=[];for(;f()>0;){let H=t.readUint8();if(H===W){let J=t.readASN1OID();u.push(J)}else H===ft&&t.expectUint8(0,0)}L(),t.expectUint8(ut,0);let x=t.readASN1BitString();this.publicKey={identifiers:u,data:x,all:t.data.subarray(m,t.offset)},A(),t.expectUint8($t,0);let[D]=t.expectASN1Length();t.expectUint8(U,0);let[$,j]=t.expectASN1Length(0);for(;j()>0;){t.expectUint8(U,0);let[H,J]=t.expectASN1Length();t.expectUint8(W,0);let B=t.readASN1OID();if(B==="2.5.29.17"){t.expectUint8(G,0);let[k]=t.expectASN1Length(0);t.expectUint8(U,0);let b=Bt(t,X);this.subjectAltNames=b.filter(C=>C.type===(2|X)).map(C=>C.name),k()}else if(B==="2.5.29.15"){t.expectUint8(gt,0);let k=t.readASN1Boolean();t.expectUint8(G,0);let[b]=t.expectASN1Length(0);t.expectUint8(ut,0);let C=t.readASN1BitString(),E=qt(C),I=new Set(oe.filter((w,V)=>E&1<<V));b(),this.keyUsage={critical:k,usages:I}}else if(B==="2.5.29.37"){this.extKeyUsage={},t.expectUint8(G,0);let[k]=t.expectASN1Length(0);t.expectUint8(U,0);let[b,C]=t.expectASN1Length(0);for(;C()>0;){t.expectUint8(W,0);let E=t.readASN1OID();E==="1.3.6.1.5.5.7.3.1"&&(this.extKeyUsage.serverTls=!0),E==="1.3.6.1.5.5.7.3.2"&&(this.extKeyUsage.clientTls=!0)}b(),k()}else if(B==="2.5.29.35"){t.expectUint8(G,0);let[k]=t.expectASN1Length(0);t.expectUint8(U,0);let[b,C]=t.expectASN1Length(0);for(;C()>0;){let E=t.readUint8();if(E===(X|0)){let[I,w]=t.expectASN1Length(0);this.authorityKeyIdentifier=t.readBytes(w()),I()}else if(E===(X|1)){let[I,w]=t.expectASN1Length(0);t.skip(w(),0),I()}else if(E===(X|2)){let[I,w]=t.expectASN1Length(0);t.skip(w(),0),I()}else if(E===(X|33)){let[I,w]=t.expectASN1Length(0);t.skip(w(),0),I()}else throw new Error(`Unexpected data type ${E} in authorityKeyIdentifier certificate extension`)}b(),k()}else if(B==="2.5.29.14"){t.expectUint8(G,0);let[k]=t.expectASN1Length(0);t.expectUint8(G,0);let[b,C]=t.expectASN1Length(0);this.subjectKeyIdentifier=t.readBytes(C()),b(),k()}else if(B==="2.5.29.19"){let k,b=t.readUint8();if(b===gt&&(k=t.readASN1Boolean(),b=t.readUint8()),b!==G)throw new Error("Unexpected type in certificate basic constraints");let[C]=t.expectASN1Length(0);t.expectUint8(U,0);let[E,I]=t.expectASN1Length(),w;I()>0&&(t.expectUint8(gt,0),w=t.readASN1Boolean());let V;if(I()>0){t.expectUint8(tt,0);let Z=t.readASN1Length(0);if(V=Z===1?t.readUint8():Z===2?t.readUint16():Z===3?t.readUint24():void 0,V===void 0)throw new Error("Too many bytes in max path length in certificate basicConstraints")}E(),C(),this.basicConstraints={critical:k,ca:w,pathLength:V}}else t.skip(J(),0);H()}$(),D(),a(),this.signedData=t.data.subarray(n,t.offset),t.expectUint8(U,0);let[q,z]=t.expectASN1Length(0);t.expectUint8(W,0);let T=t.readASN1OID();if(z()>0&&(t.expectUint8(ft,0),t.expectUint8(0,0)),q(),T!==this.algorithm)throw new Error(`Certificate specifies different signature algorithms inside (${this.algorithm}) and out (${T})`);t.expectUint8(ut,0),this.signature=t.readASN1BitString(),r()}static fromPEM(e){let t="[A-Z0-9 ]+",r=new RegExp(`-{5}BEGIN ${t}-{5}([a-zA-Z0-9=+\\/\\n\\r]+)-{5}END ${t}-{5}`,"g"),n=[],a=null;for(;a=r.exec(e);){let c=a[1].replace(/[\r\n]/g,""),s=Tt(c),o=new this(s);n.push(o)}return n}subjectAltNameMatchingHost(e){let t=/[.][^.]+[.][^.]+$/;return(this.subjectAltNames??[]).find(r=>{let n=r,a=e;if(t.test(e)&&t.test(n)&&n.startsWith("*.")&&(n=n.slice(1),a=a.slice(a.indexOf("."))),n===a)return!0})}isValidAtMoment(e=new Date){return e>=this.validityPeriod.notBefore&&e<=this.validityPeriod.notAfter}description(){return"subject: "+P.readableDN(this.subject)+(this.subjectAltNames?`
subject alt names: `+this.subjectAltNames.join(", "):"")+(this.subjectKeyIdentifier?`
subject key id: ${K(this.subjectKeyIdentifier," ")}`:"")+`
issuer: `+P.readableDN(this.issuer)+(this.authorityKeyIdentifier?`
authority key id: ${K(this.authorityKeyIdentifier," ")}`:"")+`
validity: `+this.validityPeriod.notBefore.toISOString()+" \u2013 "+this.validityPeriod.notAfter.toISOString()+` (${this.isValidAtMoment()?"currently valid":"not valid"})`+(this.keyUsage?`
key usage (${this.keyUsage.critical?"critical":"non-critical"}): `+[...this.keyUsage.usages].join(", "):"")+(this.extKeyUsage?`
extended key usage: TLS server \u2014\xA0${this.extKeyUsage.serverTls}, TLS client \u2014\xA0${this.extKeyUsage.clientTls}`:"")+(this.basicConstraints?`
basic constraints (${this.basicConstraints.critical?"critical":"non-critical"}): CA \u2014\xA0${this.basicConstraints.ca}, path length \u2014 ${this.basicConstraints.pathLength}`:"")+`
signature algorithm: `+Pt(Ft(this.algorithm))}toJSON(){return{serialNumber:[...this.serialNumber],algorithm:this.algorithm,issuer:this.issuer,validityPeriod:{notBefore:this.validityPeriod.notBefore.toISOString(),notAfter:this.validityPeriod.notAfter.toISOString()},subject:this.subject,publicKey:{identifiers:this.publicKey.identifiers,data:[...this.publicKey.data],all:[...this.publicKey.all]},signature:[...this.signature],keyUsage:{critical:this.keyUsage?.critical,usages:[...this.keyUsage?.usages??[]]},subjectAltNames:this.subjectAltNames,extKeyUsage:this.extKeyUsage,authorityKeyIdentifier:this.authorityKeyIdentifier&&[...this.authorityKeyIdentifier],subjectKeyIdentifier:this.subjectKeyIdentifier&&[...this.subjectKeyIdentifier],basicConstraints:this.basicConstraints,signedData:[...this.signedData]}}},st=class extends P{};async function pt(i,e,t,r,n){i.expectUint8(U,0);let[a]=i.expectASN1Length(0);i.expectUint8(tt,0);let[c,s]=i.expectASN1Length(0),o=i.readBytes(s());c(),i.expectUint8(tt,0);let[h,y]=i.expectASN1Length(0),d=i.readBytes(y());h(),a();let g=(u,x)=>u.length>x?u.subarray(u.length-x):u.length<x?p(new Uint8Array(x-u.length),u):u,m=r==="P-256"?32:48,A=p(g(o,m),g(d,m)),L=await l.importKey("spki",e,{name:"ECDSA",namedCurve:r},!1,["verify"]);if(await l.verify({name:"ECDSA",hash:n},L,A,t)!==!0)throw new Error("ECDSA-SECP256R1-SHA256 certificate verify failed")}async function jt(i,e,t,r=!0,n=!0){for(let h of e);let a=e[0];if(a.subjectAltNameMatchingHost(i)===void 0)throw new Error(`No matching subjectAltName for ${i}`);if(!a.isValidAtMoment())throw new Error("End-user certificate is not valid now");if(r&&!a.extKeyUsage?.serverTls)throw new Error("End-user certificate has no TLS server extKeyUsage");let o=!1;for(let h of t);for(let h=0,y=e.length;h<y;h++){let d=e[h],g=d.authorityKeyIdentifier,m;if(g===void 0?m=t.find(f=>P.distinguishedNamesAreEqual(f.subject,d.issuer)):m=t.find(f=>f.subjectKeyIdentifier!==void 0&&O(f.subjectKeyIdentifier,g)),m===void 0&&(m=e[h+1]),m===void 0)throw new Error("Ran out of certificates before reaching trusted root");let A=m instanceof st;if(m.isValidAtMoment()!==!0)throw new Error("Signing certificate is not valid now");if(n&&m.keyUsage?.usages.has("digitalSignature")!==!0)throw new Error("Signing certificate keyUsage does not include digital signatures");if(m.basicConstraints?.ca!==!0)throw new Error("Signing certificate basicConstraints do not indicate a CA certificate");let{pathLength:L}=m.basicConstraints;if(L!==void 0&&L<h)throw new Error("Exceeded certificate path length");if(d.algorithm==="1.2.840.10045.4.3.2"||d.algorithm==="1.2.840.10045.4.3.3"){let f=d.algorithm==="1.2.840.10045.4.3.2"?"SHA-256":"SHA-384",u=m.publicKey.identifiers,x=u.includes("1.2.840.10045.3.1.7")?"P-256":u.includes("1.3.132.0.34")?"P-384":void 0;if(x===void 0)throw new Error("Unsupported signing key curve");let D=new _(d.signature);await pt(D,m.publicKey.all,d.signedData,x,f)}else if(d.algorithm==="1.2.840.113549.1.1.11"||d.algorithm==="1.2.840.113549.1.1.12"){let f=d.algorithm==="1.2.840.113549.1.1.11"?"SHA-256":"SHA-384",u=await l.importKey("spki",m.publicKey.all,{name:"RSASSA-PKCS1-v1_5",hash:f},!1,["verify"]);if(await l.verify({name:"RSASSA-PKCS1-v1_5"},u,d.signature,d.signedData)!==!0)throw new Error("RSASSA_PKCS1-v1_5-SHA256 certificate verify failed")}else throw new Error("Unsupported signing algorithm");if(A){o=!0;break}}return o}var he=new TextEncoder;async function Vt(i,e,t,r,n,a=!0,c=!0){let s=new _(await e());s.expectUint8(8,0);let[o]=s.expectLengthUint24(),[h,y]=s.expectLengthUint16(0);for(;y()>0;){let R=s.readUint16(0);if(R===0)s.expectUint16(0,0);else if(R===10){let[M,F]=s.expectLengthUint16("groups data");s.skip(F(),0),M()}else throw new Error(`Unsupported server encrypted extension type 0x${K([R]).padStart(4,"0")}`)}h(),o(),s.remaining()===0&&s.extend(await e());let d=!1,g=s.readUint8();if(g===13){d=!0;let[R]=s.expectLengthUint24("certificate request data");s.expectUint8(0,0);let[M,F]=s.expectLengthUint16("certificate request extensions");s.skip(F(),0),M(),R(),s.remaining()===0&&s.extend(await e()),g=s.readUint8()}if(g!==11)throw new Error(`Unexpected handshake message type 0x${K([g])}`);let[m]=s.expectLengthUint24(0);s.expectUint8(0,0);let[A,L]=s.expectLengthUint24(0),f=[];for(;L()>0;){let[R]=s.expectLengthUint24(0),M=new P(s);f.push(M),R();let[F,et]=s.expectLengthUint16(),wt=s.subarray(et());F()}if(A(),m(),f.length===0)throw new Error("No certificates supplied");let u=f[0],x=s.data.subarray(0,s.offset),D=p(r,x),$=await l.digest("SHA-256",D),j=new Uint8Array($),q=p(he.encode(" ".repeat(64)+"TLS 1.3, server CertificateVerify"),[0],j);s.remaining()===0&&s.extend(await e()),s.expectUint8(15,0);let[z]=s.expectLengthUint24(0),T=s.readUint16();if(T===1027){let[R]=s.expectLengthUint16();await pt(s,u.publicKey.all,q,"P-256","SHA-256"),R()}else if(T===2052){let[R,M]=s.expectLengthUint16(),F=s.subarray(M());R();let et=await l.importKey("spki",u.publicKey.all,{name:"RSA-PSS",hash:"SHA-256"},!1,["verify"]);if(await l.verify({name:"RSA-PSS",saltLength:32},et,F,q)!==!0)throw new Error("RSA-PSS-RSAE-SHA256 certificate verify failed")}else throw new Error(`Unsupported certificate verify signature type 0x${K([T]).padStart(4,"0")}`);z();let H=s.data.subarray(0,s.offset),J=p(r,H),B=await S(t,"finished",new Uint8Array(0),32,256),k=await l.digest("SHA-256",J),b=await l.importKey("raw",B,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]),C=await l.sign("HMAC",b,k),E=new Uint8Array(C);s.remaining()===0&&s.extend(await e()),s.expectUint8(20,0);let[I,w]=s.expectLengthUint24(0),V=s.readBytes(w());if(I(),s.remaining()!==0)throw new Error("Unexpected extra bytes in server handshake");if(O(V,E)!==!0)throw new Error("Invalid server verify hash");if(!await jt(i,f,n,a,c))throw new Error("Validated certificate chain did not end in a trusted root");return[s.data,d]}async function de(i,e,t,r,{useSNI:n,requireServerTlsExtKeyUsage:a,requireDigitalSigKeyUsage:c,writePreData:s,expectPreData:o,commentPreData:h}={}){n??=!0,a??=!0,c??=!0;let y=await l.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey","deriveBits"]),d=await l.exportKey("raw",y.publicKey),g=new Uint8Array(32);crypto.getRandomValues(g);let A=St(i,d,g,n).array(),L=s?p(s,A):A;if(r(L),o){let v=await t(o.length);if(!v||!O(v,o))throw new Error("Pre data did not match expectation")}let f=await ht(t,22);if(f===void 0)throw new Error("Connection closed while awaiting server hello");let u=new N(f.content),x=Ut(u,g),D=await ht(t,20);if(D===void 0)throw new Error("Connection closed awaiting server cipher change");let $=new N(D.content),[j]=$.expectLength(1);$.expectUint8(1,0),j();let q=A.subarray(5),z=f.content,T=p(q,z),H=await Kt(x,y.privateKey,T,256,16),J=await l.importKey("raw",H.serverHandshakeKey,{name:"AES-GCM"},!1,["decrypt"]),B=new Q("decrypt",J,H.serverHandshakeIV),k=await l.importKey("raw",H.clientHandshakeKey,{name:"AES-GCM"},!1,["encrypt"]),b=new Q("encrypt",k,H.clientHandshakeIV),C=async()=>{let v=await dt(t,B,22);if(v===void 0)throw new Error("Premature end of encrypted server handshake");return v},[E,I]=await Vt(i,C,H.serverSecret,T,e,a,c),w=new N(6);w.writeUint8(20,0),w.writeUint16(771,0);let V=w.writeLengthUint16();w.writeUint8(1,0),V();let Z=w.array(),Y=new Uint8Array(0);if(I){let v=new N(8);v.writeUint8(11,0);let nt=v.writeLengthUint24("client certificate data");v.writeUint8(0,0),v.writeUint24(0,0),nt(),Y=v.array()}let R=p(T,E,Y),M=await l.digest("SHA-256",R),F=new Uint8Array(M),et=await S(H.clientSecret,"finished",new Uint8Array(0),32,256),wt=await l.importKey("raw",et,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]),Mt=await l.sign("HMAC",wt,F),_t=new Uint8Array(Mt),at=new N(36);at.writeUint8(20,0);let Gt=at.writeLengthUint24(0);at.writeBytes(_t),Gt();let zt=at.array(),kt=await At(p(Y,zt),b,22),Et=F;if(Y.length>0){let v=R.subarray(0,R.length-Y.length),nt=await l.digest("SHA-256",v);Et=new Uint8Array(nt)}let ct=await Dt(H.handshakeSecret,Et,256,16),Jt=await l.importKey("raw",ct.clientApplicationKey,{name:"AES-GCM"},!0,["encrypt"]),Zt=new Q("encrypt",Jt,ct.clientApplicationIV),Qt=await l.importKey("raw",ct.serverApplicationKey,{name:"AES-GCM"},!0,["decrypt"]),Wt=new Q("decrypt",Qt,ct.serverApplicationIV),ot=!1;return[()=>{if(!ot){let v=p(Z,...kt);r(v),ot=!0}return dt(t,Wt)},async v=>{let nt=ot;ot=!0;let It=await At(v,Zt,23),Xt=nt?p(...It):p(Z,...kt,...It);r(Xt)}]}var xt=class{queue;outstandingRequest;constructor(){this.queue=[]}enqueue(e){this.queue.push(e),this.dequeue()}dequeue(){if(this.outstandingRequest===void 0)return;let{resolve:e,bytes:t}=this.outstandingRequest,r=this.bytesInQueue();if(r<t&&this.socketIsNotClosed())return;if(t=Math.min(t,r),t===0)return e(void 0);this.outstandingRequest=void 0;let n=this.queue[0],a=n.length;if(a===t)return this.queue.shift(),e(n);if(a>t)return this.queue[0]=n.subarray(t),e(n.subarray(0,t));{let c=new Uint8Array(t),s=t,o=0;for(;s>0;){let h=this.queue[0],y=h.length;y<=s?(this.queue.shift(),c.set(h,o),o+=y,s-=y):(this.queue[0]=h.subarray(s),c.set(h.subarray(0,s),o),s-=s,o+=s)}return e(c)}}bytesInQueue(){return this.queue.reduce((e,t)=>e+t.length,0)}async read(e){if(this.outstandingRequest!==void 0)throw new Error("Can\u2019t read while already awaiting read");return new Promise(t=>{this.outstandingRequest={resolve:t,bytes:e},this.dequeue()})}},vt=class extends xt{constructor(t){super();this.socket=t;t.addEventListener("message",r=>this.enqueue(new Uint8Array(r.data))),t.addEventListener("close",()=>this.dequeue())}socketIsNotClosed(){let{socket:t}=this,{readyState:r}=t;return r<=1}},Lt=class extends xt{constructor(t){super();this.socket=t;t.on("data",r=>this.enqueue(new Uint8Array(r))),t.on("close",()=>this.dequeue())}socketIsNotClosed(){let{socket:t}=this,{readyState:r}=t;return r==="opening"||r==="open"}};export{Lt as SocketReadQueue,st as TrustedCert,vt as WebSocketReadQueue,de as startTls};
