function u(...s){if(s.length===1&&s[0]instanceof Uint8Array)return s[0];let e=s.reduce((n,r)=>n+r.length,0),t=new Uint8Array(e),i=0;for(let n of s)t.set(n,i),i+=n.length;return t}function O(s,e){let t=s.length;if(t!==e.length)return!1;for(let i=0;i<t;i++)if(s[i]!==e[i])return!1;return!0}var tt="\xB7\xB7 ";var vt=new TextEncoder,zt=new TextDecoder,k=class{offset;dataView;data;comments;indents;indent;constructor(e){this.offset=0,this.data=typeof e=="number"?new Uint8Array(e):e,this.dataView=new DataView(this.data.buffer,this.data.byteOffset,this.data.byteLength),this.comments={},this.indents={},this.indent=0}extend(e){let t=typeof e=="number"?new Uint8Array(e):e;this.data=u(this.data,t),this.dataView=new DataView(this.data.buffer,this.data.byteOffset,this.data.byteLength)}remaining(){return this.data.length-this.offset}subarray(e){return this.data.subarray(this.offset,this.offset+=e)}skip(e,t){return this.offset+=e,t&&this.comment(t),this}comment(e,t=this.offset){throw new Error("No comments should be emitted outside of chatty mode")}readBytes(e){return this.data.slice(this.offset,this.offset+=e)}readUTF8String(e){let t=this.subarray(e);return zt.decode(t)}readUTF8StringNullTerminated(){let e=this.offset;for(;this.data[e]!==0;)e++;let t=this.readUTF8String(e-this.offset);return this.expectUint8(0,"end of string"),t}readUint8(e){let t=this.dataView.getUint8(this.offset);return this.offset+=1,t}readUint16(e){let t=this.dataView.getUint16(this.offset);return this.offset+=2,t}readUint24(e){let t=this.readUint8(),i=this.readUint16();return(t<<16)+i}readUint32(e){let t=this.dataView.getUint32(this.offset);return this.offset+=4,t}expectBytes(e,t){let i=this.readBytes(e.length);if(!O(i,e))throw new Error("Unexpected bytes")}expectUint8(e,t){let i=this.readUint8();if(i!==e)throw new Error(`Expected ${e}, got ${i}`)}expectUint16(e,t){let i=this.readUint16();if(i!==e)throw new Error(`Expected ${e}, got ${i}`)}expectUint24(e,t){let i=this.readUint24();if(i!==e)throw new Error(`Expected ${e}, got ${i}`)}expectUint32(e,t){let i=this.readUint32();if(i!==e)throw new Error(`Expected ${e}, got ${i}`)}expectLength(e,t=1){let i=this.offset,n=i+e;if(n>this.data.length)throw new Error("Expected length exceeds remaining data length");return this.indent+=t,this.indents[i]=this.indent,[()=>{if(this.indent-=t,this.indents[this.offset]=this.indent,this.offset!==n)throw new Error(`${e} bytes expected but ${this.offset-i} read`)},()=>n-this.offset]}expectLengthUint8(e){let t=this.readUint8();return this.expectLength(t)}expectLengthUint16(e){let t=this.readUint16();return this.expectLength(t)}expectLengthUint24(e){let t=this.readUint24();return this.expectLength(t)}expectLengthUint32(e){let t=this.readUint32();return this.expectLength(t)}expectLengthUint8Incl(e){let t=this.readUint8();return this.expectLength(t-1)}expectLengthUint16Incl(e){let t=this.readUint16();return this.expectLength(t-2)}expectLengthUint24Incl(e){let t=this.readUint24();return this.expectLength(t-3)}expectLengthUint32Incl(e){let t=this.readUint32();return this.expectLength(t-4)}writeBytes(e){return this.data.set(e,this.offset),this.offset+=e.length,this}writeUTF8String(e){let t=vt.encode(e);return this.writeBytes(t),this}writeUTF8StringNullTerminated(e){let t=vt.encode(e);return this.writeBytes(t),this.writeUint8(0),this}writeUint8(e,t){return this.dataView.setUint8(this.offset,e),this.offset+=1,this}writeUint16(e,t){return this.dataView.setUint16(this.offset,e),this.offset+=2,this}writeUint24(e,t){return this.writeUint8((e&16711680)>>16),this.writeUint16(e&65535,t),this}writeUint32(e,t){return this.dataView.setUint32(this.offset,e),this.offset+=4,this}_writeLengthGeneric(e,t,i){let n=this.offset;this.offset+=e;let r=this.offset;return this.indent+=1,this.indents[r]=this.indent,()=>{let a=this.offset-(t?n:r);if(e===1)this.dataView.setUint8(n,a);else if(e===2)this.dataView.setUint16(n,a);else if(e===3)this.dataView.setUint8(n,(a&16711680)>>16),this.dataView.setUint16(n+1,a&65535);else if(e===4)this.dataView.setUint32(n,a);else throw new Error(`Invalid length for length field: ${e}`);this.indent-=1,this.indents[this.offset]=this.indent}}writeLengthUint8(e){return this._writeLengthGeneric(1,!1,e)}writeLengthUint16(e){return this._writeLengthGeneric(2,!1,e)}writeLengthUint24(e){return this._writeLengthGeneric(3,!1,e)}writeLengthUint32(e){return this._writeLengthGeneric(4,!1,e)}writeLengthUint8Incl(e){return this._writeLengthGeneric(1,!0,e)}writeLengthUint16Incl(e){return this._writeLengthGeneric(2,!0,e)}writeLengthUint24Incl(e){return this._writeLengthGeneric(3,!0,e)}writeLengthUint32Incl(e){return this._writeLengthGeneric(4,!0,e)}array(){return this.data.subarray(0,this.offset)}commentedString(e=!1){let t=this.indents[0]!==void 0?tt.repeat(this.indents[0]):"",i=this.indents[0]??0,n=e?this.data.length:this.offset;for(let r=0;r<n;r++){t+=this.data[r].toString(16).padStart(2,"0")+" ";let a=this.comments[r+1];this.indents[r+1]!==void 0&&(i=this.indents[r+1]),a&&(t+=` ${a}
${tt.repeat(i)}`)}return t}};function ft(s,e,t,i=!0){let n=new k(1024);n.writeUint8(22,0),n.writeUint16(769,0);let r=n.writeLengthUint16();n.writeUint8(1,0);let a=n.writeLengthUint24();n.writeUint16(771,0),crypto.getRandomValues(n.subarray(32));let c=n.writeLengthUint8(0);n.writeBytes(t),c();let o=n.writeLengthUint16(0);n.writeUint16(4865,0),o();let h=n.writeLengthUint8(0);n.writeUint8(0,0),h();let y=n.writeLengthUint16(0);if(i){n.writeUint16(0,0);let K=n.writeLengthUint16(0),D=n.writeLengthUint16(0);n.writeUint8(0,0);let M=n.writeLengthUint16(0);n.writeUTF8String(s),M(),D(),K()}n.writeUint16(11,0);let d=n.writeLengthUint16(0),m=n.writeLengthUint8(0);n.writeUint8(0,0),m(),d(),n.writeUint16(10,0);let p=n.writeLengthUint16(0),g=n.writeLengthUint16(0);n.writeUint16(23,0),g(),p(),n.writeUint16(13,0);let x=n.writeLengthUint16(0),E=n.writeLengthUint16(0);n.writeUint16(1027,0),n.writeUint16(2052,0),E(),x(),n.writeUint16(43,0);let f=n.writeLengthUint16(0),b=n.writeLengthUint8(0);n.writeUint16(772,0),b(),f(),n.writeUint16(51,0);let P=n.writeLengthUint16(0),$=n.writeLengthUint16(0);n.writeUint16(23,0);let F=n.writeLengthUint16(0);return n.writeBytes(new Uint8Array(e)),F(),$(),P(),y(),a(),r(),n}function H(s,e=""){return[...s].map(t=>t.toString(16).padStart(2,"0")).join(e)}function ut(s,e){let t,i,[n]=s.expectLength(s.remaining());s.expectUint8(2,0);let[r]=s.expectLengthUint24(0);s.expectUint16(771,0);let a=s.readBytes(32);if(O(a,[207,33,173,116,229,154,97,17,190,29,140,2,30,101,184,145,194,162,17,22,122,187,140,94,7,158,9,226,200,168,51,156]))throw new Error("Unexpected HelloRetryRequest");s.expectUint8(e.length,0),s.expectBytes(e,0),s.expectUint16(4865,0),s.expectUint8(0,0);let[c,o]=s.expectLengthUint16(0);for(;o()>0;){let h=s.readUint16(0),[y]=s.expectLengthUint16(0);if(h===43)s.expectUint16(772,0),i=!0;else if(h===51)s.expectUint16(23,0),s.expectUint16(65),t=s.readBytes(65);else throw new Error(`Unexpected extension 0x${H([h])}`);y()}if(c(),r(),n(),i!==!0)throw new Error("No TLS version provided");if(t===void 0)throw new Error("No key provided");return t}var we=new RegExp(`  .+|^(${tt})+`,"gm");var et=1<<14,Zt=et+1+255;async function ct(s,e,t=et){let n=await s(5);if(n===void 0)return;if(n.length<5)throw new Error("TLS record header truncated");let r=new k(n),a=r.readUint8();if(a<20||a>24)throw new Error(`Illegal TLS record type 0x${a.toString(16)}`);if(e!==void 0&&a!==e)throw new Error(`Unexpected TLS record type 0x${a.toString(16).padStart(2,"0")} (expected 0x${e.toString(16).padStart(2,"0")})`);let c=r.readUint16(0);if([769,770,771].indexOf(c)<0)throw new Error(`Unsupported TLS record version 0x${c.toString(16).padStart(4,"0")}`);let o=r.readUint16(0);if(o>t)throw new Error(`Record too long: ${o} bytes`);let h=await s(o);if(h===void 0||h.length<o)throw new Error("TLS record content truncated");return{headerData:n,header:r,type:a,version:c,length:o,content:h}}async function ot(s,e,t){let i=await ct(s,23,Zt);if(i===void 0)return;let n=new k(i.content),[r]=n.expectLength(n.remaining());n.skip(i.length-16,0),n.skip(16,0),r();let a=await e.process(i.content,16,i.headerData),c=a.length-1;for(;a[c]===0;)c-=1;if(c<0)throw new Error("Decrypted message has no record type indicator (all zeroes)");let o=a[c],h=a.subarray(0,c);if(!(o===21&&h.length===2&&h[0]===1&&h[1]===0)){if(o===22&&h[0]===4)return ot(s,e,t);if(t!==void 0&&o!==t)throw new Error(`Unexpected TLS record type 0x${o.toString(16).padStart(2,"0")} (expected 0x${t.toString(16).padStart(2,"0")})`);return h}}async function Jt(s,e,t){let i=u(s,[t]),n=5,c=i.length+16,o=new k(n+c);o.writeUint8(23,0),o.writeUint16(771,0),o.writeUint16(c,`${c} bytes follow`);let[h]=o.expectLength(c),y=o.array(),d=await e.process(i,16,y);return o.writeBytes(d.subarray(0,d.length-16)),o.writeBytes(d.subarray(d.length-16)),h(),o.array()}async function pt(s,e,t){let i=Math.ceil(s.length/et),n=[];for(let r=0;r<i;r++){let a=s.subarray(r*et,(r+1)*et),c=await Jt(a,e,t);n.push(c)}return n}var l=crypto.subtle;var Ct=new TextEncoder;async function xt(s,e,t){let i=await l.importKey("raw",s,{name:"HMAC",hash:{name:`SHA-${t}`}},!1,["sign"]);var n=new Uint8Array(await l.sign("HMAC",i,e));return n}async function Qt(s,e,t,i){let n=i>>3,r=Math.ceil(t/n),a=new Uint8Array(r*n),c=await l.importKey("raw",s,{name:"HMAC",hash:{name:`SHA-${i}`}},!1,["sign"]),o=new Uint8Array(0);for(let h=0;h<r;h++){let y=u(o,e,[h+1]),d=await l.sign("HMAC",c,y),m=new Uint8Array(d);a.set(m,n*h),o=m}return a.subarray(0,t)}var Lt=Ct.encode("tls13 ");async function S(s,e,t,i,n){let r=Ct.encode(e),a=u([(i&65280)>>8,i&255],[Lt.length+r.length],Lt,r,[t.length],t);return Qt(s,a,i,n)}async function Et(s,e,t,i,n){let r=i>>3,a=new Uint8Array(r),c=await l.importKey("raw",s,{name:"ECDH",namedCurve:"P-256"},!1,[]),o=await l.deriveBits({name:"ECDH",public:c},e,256),h=new Uint8Array(o),y=await l.digest("SHA-256",t),d=new Uint8Array(y),m=await xt(new Uint8Array(1),a,i),p=await l.digest(`SHA-${i}`,new Uint8Array(0)),g=new Uint8Array(p),x=await S(m,"derived",g,r,i),E=await xt(x,h,i),f=await S(E,"c hs traffic",d,r,i),b=await S(E,"s hs traffic",d,r,i),P=await S(f,"key",new Uint8Array(0),n,i),$=await S(b,"key",new Uint8Array(0),n,i),F=await S(f,"iv",new Uint8Array(0),12,i),K=await S(b,"iv",new Uint8Array(0),12,i);return{serverHandshakeKey:$,serverHandshakeIV:K,clientHandshakeKey:P,clientHandshakeIV:F,handshakeSecret:E,clientSecret:f,serverSecret:b}}async function It(s,e,t,i){let n=t>>3,r=new Uint8Array(n),a=await l.digest(`SHA-${t}`,new Uint8Array(0)),c=new Uint8Array(a),o=await S(s,"derived",c,n,t),h=await xt(o,r,t),y=await S(h,"c ap traffic",e,n,t),d=await S(h,"s ap traffic",e,n,t),m=await S(y,"key",new Uint8Array(0),i,t),p=await S(d,"key",new Uint8Array(0),i,t),g=await S(y,"iv",new Uint8Array(0),12,t),x=await S(d,"iv",new Uint8Array(0),12,t);return{serverApplicationKey:p,serverApplicationIV:x,clientApplicationKey:m,clientApplicationIV:g}}var Xt=1<<30,Z=class{mode;key;initialIv;ivLength;currentIv;currentIvDataView;initialIvLast32;recordsDecrypted=0;constructor(e,t,i){this.mode=e,this.key=t,this.initialIv=i,this.ivLength=i.length,this.currentIv=i.slice(),this.currentIvDataView=new DataView(this.currentIv.buffer,this.currentIv.byteOffset,this.currentIv.byteLength),this.initialIvLast32=this.currentIvDataView.getUint32(this.ivLength-4)}async process(e,t,i){if(this.recordsDecrypted===Xt)throw new Error("Cannot encrypt/decrypt any more records");let n=this.initialIvLast32^this.recordsDecrypted;this.currentIvDataView.setUint32(this.ivLength-4,n),this.recordsDecrypted+=1;let r=t<<3,a={name:"AES-GCM",iv:this.currentIv,tagLength:r,additionalData:i},c=await l[this.mode](a,this.key,e);return new Uint8Array(c)}};function ht(s){return s>64&&s<91?s-65:s>96&&s<123?s-71:s>47&&s<58?s+4:s===43?62:s===47?63:s===61?64:void 0}function kt(s){let e=s.length,t=0,i=0,n=64,r=64,a=64,c=64,o=new Uint8Array(e*.75);for(;t<e;)n=ht(s.charCodeAt(t++)),r=ht(s.charCodeAt(t++)),a=ht(s.charCodeAt(t++)),c=ht(s.charCodeAt(t++)),o[i++]=n<<2|r>>4,o[i++]=(r&15)<<4|a>>2,o[i++]=(a&3)<<6|c;let h=r===64?0:a===64?2:c===64?1:0;return o.subarray(0,i-h)}var j=class extends k{readASN1Length(e){let t=this.readUint8();if(t<128)return t;let i=t&127,n=0;if(i===1)return this.readUint8(n);if(i===2)return this.readUint16(n);if(i===3)return this.readUint24(n);if(i===4)return this.readUint32(n);throw new Error(`ASN.1 length fields are only supported up to 4 bytes (this one is ${i} bytes)`)}expectASN1Length(e){let t=this.readASN1Length(e);return this.expectLength(t)}readASN1OID(){let[e,t]=this.expectASN1Length(0),i=this.readUint8(),n=`${Math.floor(i/40)}.${i%40}`;for(;t()>0;){let r=0;for(;;){let a=this.readUint8();if(r<<=7,r+=a&127,a<128)break}n+=`.${r}`}return e(),n}readASN1Boolean(){let[e,t]=this.expectASN1Length(0),i=t();if(i!==1)throw new Error(`Boolean has weird length: ${i}`);let n=this.readUint8(),r;if(n===255)r=!0;else if(n===0)r=!1;else throw new Error(`Boolean has weird value: 0x${H([n])}`);return e(),r}readASN1UTCTime(){let[e,t]=this.expectASN1Length(0),n=this.readUTF8String(t()).match(/^(\d\d)(\d\d)(\d\d)(\d\d)(\d\d)(\d\d)Z$/);if(!n)throw new Error("Unrecognised UTC time format in certificate validity");let[,r,a,c,o,h,y]=n,d=parseInt(r,10),m=d+(d>=50?1900:2e3),p=new Date(`${m}-${a}-${c}T${o}:${h}:${y}Z`);return e(),p}readASN1BitString(){let[e,t]=this.expectASN1Length(0),i=this.readUint8(0),n=t(),r=this.readBytes(n);if(i>7)throw new Error(`Invalid right pad value: ${i}`);if(i>0){let a=8-i;for(let c=n-1;c>0;c--)r[c]=255&r[c-1]<<a|r[c]>>>i;r[0]=r[0]>>>i}return e(),r}};var dt=1,X=2,A=48,Wt=49,J=6,Yt=19,te=12,wt=23,yt=5,G=4,lt=3,Kt=163,W=128;var ee={"2.5.4.6":"C","2.5.4.10":"O","2.5.4.11":"OU","2.5.4.3":"CN","2.5.4.7":"L","2.5.4.8":"ST","2.5.4.12":"T","2.5.4.42":"GN","2.5.4.43":"I","2.5.4.4":"SN","1.2.840.113549.1.9.1":"E-mail"};function Dt(s){let{length:e}=s;if(e>4)throw new Error(`Bit string length ${e} would overflow JS bit operators`);let t=0,i=0;for(let n=s.length-1;n>=0;n--)t|=s[n]<<i,i+=8;return t}function Ut(s,e){let t={};s.expectUint8(A,0);let[i,n]=s.expectASN1Length(0);for(;n()>0;){s.expectUint8(Wt,0);let[r]=s.expectASN1Length(0);s.expectUint8(A,0);let[a]=s.expectASN1Length(0);s.expectUint8(J,0);let c=s.readASN1OID(),o=ee[c]??c,h=s.readUint8();if(h!==Yt){if(h!==te)throw new Error(`Unexpected item type in certificate ${e}: 0x${H([h])}`)}let[y,d]=s.expectASN1Length(0),m=s.readUTF8String(d());if(y(),a(),r(),t[o]!==void 0)throw new Error(`Duplicate OID ${o} in certificate ${e}`);t[o]=m}return i(),t}function Ht(s,e=0){let t=[],[i,n]=s.expectASN1Length(0);for(;n()>0;){let r=s.readUint8(0),[a,c]=s.expectASN1Length(0),o;r===(e|2)?o=s.readUTF8String(c()):o=s.readBytes(c()),t.push({name:o,type:r}),a()}return i(),t}function Tt(s){let e={"1.2.840.113549.1.1.1":{name:"RSAES-PKCS1-v1_5"},"1.2.840.113549.1.1.5":{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-1"}},"1.2.840.113549.1.1.11":{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},"1.2.840.113549.1.1.12":{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-384"}},"1.2.840.113549.1.1.13":{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-512"}},"1.2.840.113549.1.1.10":{name:"RSA-PSS"},"1.2.840.113549.1.1.7":{name:"RSA-OAEP"},"1.2.840.10045.2.1":{name:"ECDSA",hash:{name:"SHA-1"}},"1.2.840.10045.4.1":{name:"ECDSA",hash:{name:"SHA-1"}},"1.2.840.10045.4.3.2":{name:"ECDSA",hash:{name:"SHA-256"}},"1.2.840.10045.4.3.3":{name:"ECDSA",hash:{name:"SHA-384"}},"1.2.840.10045.4.3.4":{name:"ECDSA",hash:{name:"SHA-512"}},"1.3.133.16.840.63.0.2":{name:"ECDH",kdf:"SHA-1"},"1.3.132.1.11.1":{name:"ECDH",kdf:"SHA-256"},"1.3.132.1.11.2":{name:"ECDH",kdf:"SHA-384"},"1.3.132.1.11.3":{name:"ECDH",kdf:"SHA-512"},"2.16.840.1.101.3.4.1.2":{name:"AES-CBC",length:128},"2.16.840.1.101.3.4.1.22":{name:"AES-CBC",length:192},"2.16.840.1.101.3.4.1.42":{name:"AES-CBC",length:256},"2.16.840.1.101.3.4.1.6":{name:"AES-GCM",length:128},"2.16.840.1.101.3.4.1.26":{name:"AES-GCM",length:192},"2.16.840.1.101.3.4.1.46":{name:"AES-GCM",length:256},"2.16.840.1.101.3.4.1.4":{name:"AES-CFB",length:128},"2.16.840.1.101.3.4.1.24":{name:"AES-CFB",length:192},"2.16.840.1.101.3.4.1.44":{name:"AES-CFB",length:256},"2.16.840.1.101.3.4.1.5":{name:"AES-KW",length:128},"2.16.840.1.101.3.4.1.25":{name:"AES-KW",length:192},"2.16.840.1.101.3.4.1.45":{name:"AES-KW",length:256},"1.2.840.113549.2.7":{name:"HMAC",hash:{name:"SHA-1"}},"1.2.840.113549.2.9":{name:"HMAC",hash:{name:"SHA-256"}},"1.2.840.113549.2.10":{name:"HMAC",hash:{name:"SHA-384"}},"1.2.840.113549.2.11":{name:"HMAC",hash:{name:"SHA-512"}},"1.2.840.113549.1.9.16.3.5":{name:"DH"},"1.3.14.3.2.26":{name:"SHA-1"},"2.16.840.1.101.3.4.2.1":{name:"SHA-256"},"2.16.840.1.101.3.4.2.2":{name:"SHA-384"},"2.16.840.1.101.3.4.2.3":{name:"SHA-512"},"1.2.840.113549.1.5.12":{name:"PBKDF2"},"1.2.840.10045.3.1.7":{name:"P-256"},"1.3.132.0.34":{name:"P-384"},"1.3.132.0.35":{name:"P-521"}}[s];if(e===void 0)throw new Error(`Unsupported algorithm identifier: ${s}`);return e}function Nt(s,e=[]){return Object.values(s).forEach(t=>{typeof t=="string"?e=[...e,t]:e=Nt(t,e)}),e}function Rt(s){return Nt(s).join(" / ")}var ne=["digitalSignature","nonRepudiation","keyEncipherment","dataEncipherment","keyAgreement","keyCertSign","cRLSign","encipherOnly","decipherOnly"],nt=class{serialNumber;algorithm;issuer;validityPeriod;subject;publicKey;signature;keyUsage;subjectAltNames;extKeyUsage;authorityKeyIdentifier;subjectKeyIdentifier;basicConstraints;signedData;constructor(e){let t=e instanceof j?e:new j(e);t.expectUint8(A,0);let[i]=t.expectASN1Length(0),n=t.offset;t.expectUint8(A,0);let[r]=t.expectASN1Length(0);t.expectBytes([160,3,2,1,2],0),t.expectUint8(X,0);let[a,c]=t.expectASN1Length(0);this.serialNumber=t.subarray(c()),a(),t.expectUint8(A,0);let[o,h]=t.expectASN1Length(0);t.expectUint8(J,0),this.algorithm=t.readASN1OID(),h()>0&&(t.expectUint8(yt,0),t.expectUint8(0,0)),o(),this.issuer=Ut(t,"issuer"),t.expectUint8(A,0);let[y]=t.expectASN1Length(0);t.expectUint8(wt,0);let d=t.readASN1UTCTime();t.expectUint8(wt,0);let m=t.readASN1UTCTime();this.validityPeriod={notBefore:d,notAfter:m},y(),this.subject=Ut(t,"subject");let p=t.offset;t.expectUint8(A,0);let[g]=t.expectASN1Length(0);t.expectUint8(A,0);let[x,E]=t.expectASN1Length(0),f=[];for(;E()>0;){let _=t.readUint8();if(_===J){let z=t.readASN1OID();f.push(z)}else _===yt&&t.expectUint8(0,0)}x(),t.expectUint8(lt,0);let b=t.readASN1BitString();this.publicKey={identifiers:f,data:b,all:t.data.subarray(p,t.offset)},g(),t.expectUint8(Kt,0);let[P]=t.expectASN1Length();t.expectUint8(A,0);let[$,F]=t.expectASN1Length(0);for(;F()>0;){t.expectUint8(A,0);let[_,z]=t.expectASN1Length();t.expectUint8(J,0);let q=t.readASN1OID();if(q==="2.5.29.17"){t.expectUint8(G,0);let[I]=t.expectASN1Length(0);t.expectUint8(A,0);let v=Ht(t,W);this.subjectAltNames=v.filter(L=>L.type===(2|W)).map(L=>L.name),I()}else if(q==="2.5.29.15"){t.expectUint8(dt,0);let I=t.readASN1Boolean();t.expectUint8(G,0);let[v]=t.expectASN1Length(0);t.expectUint8(lt,0);let L=t.readASN1BitString(),U=Dt(L),T=new Set(ne.filter((R,N)=>U&1<<N));v(),this.keyUsage={critical:I,usages:T}}else if(q==="2.5.29.37"){this.extKeyUsage={},t.expectUint8(G,0);let[I]=t.expectASN1Length(0);t.expectUint8(A,0);let[v,L]=t.expectASN1Length(0);for(;L()>0;){t.expectUint8(J,0);let U=t.readASN1OID();U==="1.3.6.1.5.5.7.3.1"&&(this.extKeyUsage.serverTls=!0),U==="1.3.6.1.5.5.7.3.2"&&(this.extKeyUsage.clientTls=!0)}v(),I()}else if(q==="2.5.29.35"){t.expectUint8(G,0);let[I]=t.expectASN1Length(0);t.expectUint8(A,0);let[v,L]=t.expectASN1Length(0);for(;L()>0;){let U=t.readUint8();if(U===(W|0)){let[T,R]=t.expectASN1Length(0);this.authorityKeyIdentifier=t.readBytes(R()),T()}else if(U===(W|1)||U===(W|2)){let[T,R]=t.expectASN1Length(0);t.skip(R(),0),T()}else throw new Error("Unexpected data type in authorityKeyIdentifier certificate extension")}v(),I()}else if(q==="2.5.29.14"){t.expectUint8(G,0);let[I]=t.expectASN1Length(0);t.expectUint8(G,0);let[v,L]=t.expectASN1Length(0);this.subjectKeyIdentifier=t.readBytes(L()),v(),I()}else if(q==="2.5.29.19"){let I,v=t.readUint8();if(v===dt&&(I=t.readASN1Boolean(),v=t.readUint8()),v!==G)throw new Error("Unexpected type in certificate basic constraints");let[L]=t.expectASN1Length(0);t.expectUint8(A,0);let[U,T]=t.expectASN1Length(),R;T()>0&&(t.expectUint8(dt,0),R=t.readASN1Boolean());let N;if(T()>0){t.expectUint8(X,0);let w=t.readASN1Length(0);if(N=w===1?t.readUint8():w===2?t.readUint16():w===3?t.readUint24():void 0,N===void 0)throw new Error("Too many bytes in max path length in certificate basicConstraints")}U(),L(),this.basicConstraints={critical:I,ca:R,pathLength:N}}else t.skip(z(),0);_()}$(),P(),r(),this.signedData=t.data.subarray(n,t.offset),t.expectUint8(A,0);let[K,D]=t.expectASN1Length(0);t.expectUint8(J,0);let M=t.readASN1OID();if(D()>0&&(t.expectUint8(yt,0),t.expectUint8(0,0)),K(),M!==this.algorithm)throw new Error(`Certificate specifies different signature algorithms inside (${this.algorithm}) and out (${M})`);t.expectUint8(lt,0),this.signature=t.readASN1BitString(),i()}static fromPEM(e){let t="[A-Z0-9 ]+",i=new RegExp(`-{5}BEGIN ${t}-{5}([a-zA-Z0-9=+\\/\\n\\r]+)-{5}END ${t}-{5}`,"g"),n=[],r=null;for(;r=i.exec(e);){let a=r[1].replace(/[\r\n]/g,""),c=kt(a),o=new this(c);n.push(o)}return n}subjectAltNameMatchingHost(e){let t=/[.][^.]+[.][^.]+$/;return(this.subjectAltNames??[]).find(i=>{let n=i,r=e;if(t.test(e)&&t.test(n)&&n.startsWith("*.")&&(n=n.slice(1),r=r.slice(r.indexOf("."))),n===r)return!0})}isValidAtMoment(e=new Date){return e>=this.validityPeriod.notBefore&&e<=this.validityPeriod.notAfter}description(){return"subject: "+Object.entries(this.subject).map(e=>e.join("=")).join(", ")+(this.subjectAltNames?`
subject alt names: `+this.subjectAltNames.join(", "):"")+(this.subjectKeyIdentifier?`
subject key id: ${H(this.subjectKeyIdentifier," ")}`:"")+`
issuer: `+Object.entries(this.issuer).map(e=>e.join("=")).join(", ")+(this.authorityKeyIdentifier?`
authority key id: ${H(this.authorityKeyIdentifier," ")}`:"")+`
validity: `+this.validityPeriod.notBefore.toISOString()+" \u2013 "+this.validityPeriod.notAfter.toISOString()+` (${this.isValidAtMoment()?"currently valid":"not valid"})`+(this.keyUsage?`
key usage (${this.keyUsage.critical?"critical":"non-critical"}): `+[...this.keyUsage.usages].join(", "):"")+(this.extKeyUsage?`
extended key usage: TLS server \u2014\xA0${this.extKeyUsage.serverTls}, TLS client \u2014\xA0${this.extKeyUsage.clientTls}`:"")+(this.basicConstraints?`
basic constraints (${this.basicConstraints.critical?"critical":"non-critical"}): CA \u2014\xA0${this.basicConstraints.ca}, path length \u2014 ${this.basicConstraints.pathLength}`:"")+`
signature algorithm: `+Rt(Tt(this.algorithm))}toJSON(){return{serialNumber:[...this.serialNumber],algorithm:this.algorithm,issuer:this.issuer,validityPeriod:{notBefore:this.validityPeriod.notBefore.toISOString(),notAfter:this.validityPeriod.notAfter.toISOString()},subject:this.subject,publicKey:{identifiers:this.publicKey.identifiers,data:[...this.publicKey.data],all:[...this.publicKey.all]},signature:[...this.signature],keyUsage:{critical:this.keyUsage?.critical,usages:[...this.keyUsage?.usages??[]]},subjectAltNames:this.subjectAltNames,extKeyUsage:this.extKeyUsage,authorityKeyIdentifier:this.authorityKeyIdentifier&&[...this.authorityKeyIdentifier],subjectKeyIdentifier:this.subjectKeyIdentifier&&[...this.subjectKeyIdentifier],basicConstraints:this.basicConstraints,signedData:[...this.signedData]}}},it=class extends nt{};async function mt(s,e,t,i,n){s.expectUint8(A,0);let[r]=s.expectASN1Length(0);s.expectUint8(X,0);let[a,c]=s.expectASN1Length(0),o=s.readBytes(c());a(),s.expectUint8(X,0);let[h,y]=s.expectASN1Length(0),d=s.readBytes(y());h(),r();let m=(f,b)=>f.length>b?f.subarray(f.length-b):f.length<b?u(new Uint8Array(b-f.length),f):f,p=i==="P-256"?32:48,g=u(m(o,p),m(d,p)),x=await l.importKey("spki",e,{name:"ECDSA",namedCurve:i},!1,["verify"]);if(await l.verify({name:"ECDSA",hash:n},x,g,t)!==!0)throw new Error("ECDSA-SECP256R1-SHA256 certificate verify failed")}async function $t(s,e,t){for(let c of e);let i=e[0];if(i.subjectAltNameMatchingHost(s)===void 0)throw new Error(`No matching subjectAltName for ${s}`);if(!i.isValidAtMoment())throw new Error("End-user certificate is not valid now");if(!i.extKeyUsage?.serverTls)throw new Error("End-user certificate has no TLS server extKeyUsage");let a=!1;for(let c of t);for(let c=0,o=e.length;c<o;c++){let h=e[c],y=h.authorityKeyIdentifier;if(y===void 0)throw new Error("Certificates without an authorityKeyIdentifier are not supported");let d=t.find(g=>g.subjectKeyIdentifier!==void 0&&O(g.subjectKeyIdentifier,y));if(d===void 0&&(d=e[c+1]),d===void 0)throw new Error("Ran out of certificates before reaching trusted root");let m=d instanceof it;if(d.isValidAtMoment()!==!0)throw new Error("Signing certificate is not valid now");if(d.keyUsage?.usages.has("digitalSignature")!==!0)throw new Error("Signing certificate keyUsage does not include digital signatures");if(d.basicConstraints?.ca!==!0)throw new Error("Signing certificate basicConstraints do not indicate a CA certificate");let{pathLength:p}=d.basicConstraints;if(p!==void 0&&p<c)throw new Error("Exceeded certificate path length");if(h.algorithm==="1.2.840.10045.4.3.2"||h.algorithm==="1.2.840.10045.4.3.3"){let g=h.algorithm==="1.2.840.10045.4.3.2"?"SHA-256":"SHA-384",x=d.publicKey.identifiers,E=x.includes("1.2.840.10045.3.1.7")?"P-256":x.includes("1.3.132.0.34")?"P-384":void 0;if(E===void 0)throw new Error("Unsupported signing key curve");let f=new j(h.signature);await mt(f,d.publicKey.all,h.signedData,E,g)}else if(h.algorithm==="1.2.840.113549.1.1.11"||h.algorithm==="1.2.840.113549.1.1.12"){let g=h.algorithm==="1.2.840.113549.1.1.11"?"SHA-256":"SHA-384",x=await l.importKey("spki",d.publicKey.all,{name:"RSASSA-PKCS1-v1_5",hash:g},!1,["verify"]);if(await l.verify({name:"RSASSA-PKCS1-v1_5"},x,h.signature,h.signedData)!==!0)throw new Error("RSASSA_PKCS1-v1_5-SHA256 certificate verify failed")}else throw new Error("Unsupported signing algorithm");if(m){a=!0;break}}return a}var ie=new TextEncoder;async function qt(s,e,t,i,n){let r=new j(await e());r.expectUint8(8,0);let[a]=r.expectLengthUint24(),[c,o]=r.expectLengthUint16(0);for(;o()>0;){let w=r.readUint16(0);if(w===0)r.expectUint16(0,0);else if(w===10){let[V,B]=r.expectLengthUint16("groups data");r.skip(B(),0),V()}else throw new Error(`Unsupported server encrypted extension type 0x${H([w]).padStart(4,"0")}`)}c(),a(),r.remaining()===0&&r.extend(await e());let h=!1,y=r.readUint8();if(y===13){h=!0;let[w]=r.expectLengthUint24("certificate request data");r.expectUint8(0,0);let[V,B]=r.expectLengthUint16("certificate request extensions");r.skip(B(),0),V(),w(),r.remaining()===0&&r.extend(await e()),y=r.readUint8()}if(y!==11)throw new Error(`Unexpected handshake message type 0x${H([y])}`);let[d]=r.expectLengthUint24(0);r.expectUint8(0,0);let[m,p]=r.expectLengthUint24(0),g=[];for(;p()>0;){let[w]=r.expectLengthUint24(0),V=new nt(r);g.push(V),w();let[B,Y]=r.expectLengthUint16(),gt=r.subarray(Y());B()}if(m(),d(),g.length===0)throw new Error("No certificates supplied");let x=g[0],E=r.data.subarray(0,r.offset),f=u(i,E),b=await l.digest("SHA-256",f),P=new Uint8Array(b),$=u(ie.encode(" ".repeat(64)+"TLS 1.3, server CertificateVerify"),[0],P);r.remaining()===0&&r.extend(await e()),r.expectUint8(15,0);let[F]=r.expectLengthUint24(0),K=r.readUint16();if(K===1027){let[w]=r.expectLengthUint16();await mt(r,x.publicKey.all,$,"P-256","SHA-256"),w()}else if(K===2052){let[w,V]=r.expectLengthUint16(),B=r.subarray(V());w();let Y=await l.importKey("spki",x.publicKey.all,{name:"RSA-PSS",hash:"SHA-256"},!1,["verify"]);if(await l.verify({name:"RSA-PSS",saltLength:32},Y,B,$)!==!0)throw new Error("RSA-PSS-RSAE-SHA256 certificate verify failed")}else throw new Error(`Unsupported certificate verify signature type 0x${H([K]).padStart(4,"0")}`);F();let D=r.data.subarray(0,r.offset),M=u(i,D),_=await S(t,"finished",new Uint8Array(0),32,256),z=await l.digest("SHA-256",M),q=await l.importKey("raw",_,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]),I=await l.sign("HMAC",q,z),v=new Uint8Array(I);r.remaining()===0&&r.extend(await e()),r.expectUint8(20,0);let[L,U]=r.expectLengthUint24(0),T=r.readBytes(U());if(L(),r.remaining()!==0)throw new Error("Unexpected extra bytes in server handshake");if(O(T,v)!==!0)throw new Error("Invalid server verify hash");if(!await $t(s,g,n))throw new Error("Validated certificate chain did not end in a trusted root");return[r.data,h]}async function re(s,e,t,i,n=!0,r,a,c){let o=await l.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey","deriveBits"]),h=await l.exportKey("raw",o.publicKey),y=new Uint8Array(32);crypto.getRandomValues(y);let m=ft(s,h,y,n).array(),p=r?u(r,m):m;if(i(p),a){let C=await t(a.length);if(!C||!O(C,a))throw new Error("Pre data did not match expectation")}let g=await ct(t,22);if(g===void 0)throw new Error("Connection closed while awaiting server hello");let x=new k(g.content),E=ut(x,y),f=await ct(t,20);if(f===void 0)throw new Error("Connection closed awaiting server cipher change");let b=new k(f.content),[P]=b.expectLength(1);b.expectUint8(1,0),P();let $=m.subarray(5),F=g.content,K=u($,F),D=await Et(E,o.privateKey,K,256,16),M=await l.importKey("raw",D.serverHandshakeKey,{name:"AES-GCM"},!1,["decrypt"]),_=new Z("decrypt",M,D.serverHandshakeIV),z=await l.importKey("raw",D.clientHandshakeKey,{name:"AES-GCM"},!1,["encrypt"]),q=new Z("encrypt",z,D.clientHandshakeIV),I=async()=>{let C=await ot(t,_,22);if(C===void 0)throw new Error("Premature end of encrypted server handshake");return C},[v,L]=await qt(s,I,D.serverSecret,K,e),U=new k(6);U.writeUint8(20,0),U.writeUint16(771,0);let T=U.writeLengthUint16();U.writeUint8(1,0),T();let R=U.array(),N=new Uint8Array(0);if(L){let C=new k(8);C.writeUint8(11,0);let Q=C.writeLengthUint24("client certificate data");C.writeUint8(0,0),C.writeUint24(0,0),Q(),N=C.array()}let w=u(K,v,N),V=await l.digest("SHA-256",w),B=new Uint8Array(V),Y=await S(D.clientSecret,"finished",new Uint8Array(0),32,256),gt=await l.importKey("raw",Y,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]),Bt=await l.sign("HMAC",gt,B),Ot=new Uint8Array(Bt),rt=new k(36);rt.writeUint8(20,0);let Pt=rt.writeLengthUint24(0);rt.writeBytes(Ot),Pt();let Ft=rt.array(),At=await pt(u(N,Ft),q,22),bt=B;if(N.length>0){let C=w.subarray(0,w.length-N.length),Q=await l.digest("SHA-256",C);bt=new Uint8Array(Q)}let st=await It(D.handshakeSecret,bt,256,16),Vt=await l.importKey("raw",st.clientApplicationKey,{name:"AES-GCM"},!1,["encrypt"]),jt=new Z("encrypt",Vt,st.clientApplicationIV),Mt=await l.importKey("raw",st.serverApplicationKey,{name:"AES-GCM"},!1,["decrypt"]),_t=new Z("decrypt",Mt,st.serverApplicationIV),at=!1;return[()=>{if(!at){let C=u(R,...At);i(C),at=!0}return ot(t,_t)},async C=>{let Q=await pt(C,jt,23),Gt=at?u(...Q):u(R,...At,...Q);i(Gt),at=!0}]}var St=class{constructor(e){this.ws=e;this.queue=[],e.addEventListener("message",t=>this.enqueue(new Uint8Array(t.data))),e.addEventListener("close",()=>this.dequeue())}queue;outstandingRequest;enqueue(e){this.queue.push(e),this.dequeue()}dequeue(){if(this.outstandingRequest===void 0)return;let{resolve:e,bytes:t}=this.outstandingRequest,i=this.bytesInQueue();if(i<t&&this.ws.readyState<=1)return;if(t=Math.min(t,i),t===0)return e(void 0);this.outstandingRequest=void 0;let n=this.queue[0],r=n.length;if(r===t)return this.queue.shift(),e(n);if(r>t)return this.queue[0]=n.subarray(t),e(n.subarray(0,t));{let a=new Uint8Array(t),c=t,o=0;for(;c>0;){let h=this.queue[0],y=h.length;y<=c?(this.queue.shift(),a.set(h,o),o+=y,c-=y):(this.queue[0]=h.subarray(c),a.set(h.subarray(0,c),o),c-=c,o+=c)}return e(a)}}bytesInQueue(){return this.queue.reduce((e,t)=>e+t.length,0)}async read(e){if(this.outstandingRequest!==void 0)throw new Error("Can\u2019t read while already awaiting read");return new Promise(t=>{this.outstandingRequest={resolve:t,bytes:e},this.dequeue()})}};export{St as ReadQueue,it as TrustedCert,re as startTls};
