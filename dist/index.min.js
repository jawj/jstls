var _=class{constructor(e){this.ws=e;this.queue=[],e.addEventListener("message",t=>this.enqueue(new Uint8Array(t.data))),e.addEventListener("close",()=>this.dequeue())}queue;outstandingRequest;enqueue(e){this.queue.push(e),this.dequeue()}dequeue(){if(this.outstandingRequest===void 0)return;let{resolve:e,bytes:t}=this.outstandingRequest,n=this.bytesInQueue();if(n<t&&this.ws.readyState<=1)return;if(t=Math.min(t,n),t===0)return e(void 0);this.outstandingRequest=void 0;let i=this.queue[0],s=i.length;if(s===t)return this.queue.shift(),e(i);if(s>t)return this.queue[0]=i.subarray(t),e(i.subarray(0,t));{let c=new Uint8Array(t),a=t,o=0;for(;a>0;){let h=this.queue[0],d=h.length;d<=a?(this.queue.shift(),c.set(h,o),o+=d,a-=d):(this.queue[0]=h.subarray(a),c.set(h.subarray(0,a),o),a-=a,o+=a)}return e(c)}}bytesInQueue(){return this.queue.reduce((e,t)=>e+t.length,0)}async read(e){if(this.outstandingRequest!==void 0)throw new Error("Can\u2019t read while already awaiting read");return new Promise(t=>{this.outstandingRequest={resolve:t,bytes:e},this.dequeue()})}};function p(...r){if(r.length===1&&r[0]instanceof Uint8Array)return r[0];let e=r.reduce((i,s)=>i+s.length,0),t=new Uint8Array(e),n=0;for(let i of r)t.set(i,n),n+=i.length;return t}function Q(r,e){let t=r.length;if(t!==e.length)return!1;for(let n=0;n<t;n++)if(r[n]!==e[n])return!1;return!0}var J="\xB7\xB7 ";var Pt=new TextEncoder,$t=new TextDecoder,f=class{offset;dataView;data;comments;indents;indent;constructor(e){this.offset=0,this.data=typeof e=="number"?new Uint8Array(e):e,this.dataView=new DataView(this.data.buffer,this.data.byteOffset,this.data.byteLength),this.comments={},this.indents={},this.indent=0}extend(e){let t=typeof e=="number"?new Uint8Array(e):e;this.data=p(this.data,t),this.dataView=new DataView(this.data.buffer,this.data.byteOffset,this.data.byteLength)}remaining(){return this.data.length-this.offset}subarray(e){return this.data.subarray(this.offset,this.offset+=e)}skip(e,t){return this.offset+=e,t&&this.comment(t),this}comment(e,t=this.offset){throw new Error("No comments should be emitted outside of chatty mode")}readBytes(e){return this.data.slice(this.offset,this.offset+=e)}readUTF8String(e){let t=this.subarray(e);return $t.decode(t)}readUint8(e){let t=this.dataView.getUint8(this.offset);return this.offset+=1,t}readUint16(e){let t=this.dataView.getUint16(this.offset);return this.offset+=2,t}readUint24(e){let t=this.readUint8(),n=this.readUint16();return(t<<16)+n}readUint32(e){let t=this.dataView.getUint32(this.offset);return this.offset+=4,t}expectBytes(e,t){let n=this.readBytes(e.length);if(!Q(n,e))throw new Error("Unexpected bytes")}expectUint8(e,t){let n=this.readUint8();if(n!==e)throw new Error(`Expected ${e}, got ${n}`)}expectUint16(e,t){let n=this.readUint16();if(n!==e)throw new Error(`Expected ${e}, got ${n}`)}expectUint24(e,t){let n=this.readUint24();if(n!==e)throw new Error(`Expected ${e}, got ${n}`)}expectLength(e,t=1){let n=this.offset,i=n+e;if(i>this.data.length)throw new Error("Expected length exceeds remaining data length");return this.indent+=t,this.indents[n]=this.indent,[()=>{if(this.indent-=t,this.indents[this.offset]=this.indent,this.offset!==i)throw new Error(`${e} bytes expected but ${this.offset-n} read`)},()=>i-this.offset]}expectLengthUint8(e){let t=this.readUint8();return this.expectLength(t)}expectLengthUint16(e){let t=this.readUint16();return this.expectLength(t)}expectLengthUint24(e){let t=this.readUint24();return this.expectLength(t)}writeBytes(e){return this.data.set(e,this.offset),this.offset+=e.length,this}writeUTF8String(e){let t=Pt.encode(e);return this.writeBytes(t),this}writeUint8(e,t){return this.dataView.setUint8(this.offset,e),this.offset+=1,this}writeUint16(e,t){return this.dataView.setUint16(this.offset,e),this.offset+=2,this}_writeLengthGeneric(e,t){let n=this.offset;this.offset+=e;let i=this.offset;return this.indent+=1,this.indents[i]=this.indent,()=>{let s=this.offset-i;if(e===1)this.dataView.setUint8(n,s);else if(e===2)this.dataView.setUint16(n,s);else if(e===3)this.dataView.setUint8(n,(s&16711680)>>16),this.dataView.setUint16(n+1,s&65535);else throw new Error(`Invalid length for length field: ${e}`);this.indent-=1,this.indents[this.offset]=this.indent}}writeLengthUint8(e){return this._writeLengthGeneric(1,e)}writeLengthUint16(e){return this._writeLengthGeneric(2,e)}writeLengthUint24(e){return this._writeLengthGeneric(3,e)}array(){return this.data.subarray(0,this.offset)}commentedString(e=!1){let t=this.indents[0]!==void 0?J.repeat(this.indents[0]):"",n=this.indents[0]??0,i=e?this.data.length:this.offset;for(let s=0;s<i;s++){t+=this.data[s].toString(16).padStart(2,"0")+" ";let c=this.comments[s+1];this.indents[s+1]!==void 0&&(n=this.indents[s+1]),c&&(t+=` ${c}
${J.repeat(n)}`)}return t}};var xe=new RegExp(`  .+|^(${J})+`,"gm");var Gt=document.querySelector("#logs"),At={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&apos;"},Yt=new RegExp("["+Object.keys(At).join("")+"]","g");function zt(r){return r.replace(Yt,e=>At[e])}function Jt(...r){let e="<span>",t,n,i="";for(;(t=r.shift())!==void 0;){t=i+zt(String(t)),i=" ";let s=/([\s\S]*?)%([csoOidf])|[\s\S]+/g;for(;(n=s.exec(t))!==null;){let[c,a,o]=n;o===void 0?e+=c:(e+=a,o==="c"?e+=`</span><span style="${r.shift()}">`:o==="s"?e+=r.shift():o==="o"||o==="O"?e+=JSON.stringify(r.shift(),void 0,o==="O"?2:void 0):(o==="i"||o==="d"||o==="f")&&(e+=String(r.shift())))}}return e+="</span>",e}function ct(...r){console.log(...r),Gt.innerHTML+='<label><input type="checkbox"><div class="section">'+Jt(...r)+"</div></label>",document.body.scrollTo({top:999999})}function ht(r,e,t){let n=new f(1024);n.writeUint8(22),n.writeUint16(769);let i=n.writeLengthUint16();n.writeUint8(1);let s=n.writeLengthUint24();n.writeUint16(771),crypto.getRandomValues(n.subarray(32));let c=n.writeLengthUint8(0);n.writeBytes(t),c();let a=n.writeLengthUint16(0);n.writeUint16(4865),a();let o=n.writeLengthUint8(0);n.writeUint8(0),o();let h=n.writeLengthUint16(0);n.writeUint16(0);let d=n.writeLengthUint16(0),y=n.writeLengthUint16(0);n.writeUint8(0);let g=n.writeLengthUint16(0);n.writeUTF8String(r),g(),y(),d(),n.writeUint16(11);let u=n.writeLengthUint16(0),m=n.writeLengthUint8(0);n.writeUint8(0),m(),u(),n.writeUint16(10);let w=n.writeLengthUint16(0),S=n.writeLengthUint16(0);n.writeUint16(23),S(),w(),n.writeUint16(13);let l=n.writeLengthUint16(0),U=n.writeLengthUint16(0);n.writeUint16(1027),n.writeUint16(2052),U(),l(),n.writeUint16(43);let B=n.writeLengthUint16(0),K=n.writeLengthUint8(0);n.writeUint16(772),K(),B(),n.writeUint16(51);let R=n.writeLengthUint16(0),M=n.writeLengthUint16(0);n.writeUint16(23);let j=n.writeLengthUint16(0);return n.writeBytes(new Uint8Array(e)),j(),M(),R(),h(),s(),i(),n}function N(r,e=""){return[...r].map(t=>t.toString(16).padStart(2,"0")).join(e)}function yt(r,e){let t,n,[i]=r.expectLength(r.remaining());r.expectUint8(2,0);let[s]=r.expectLengthUint24(0);r.expectUint16(771,0);let c=r.readBytes(32);if(Q(c,[207,33,173,116,229,154,97,17,190,29,140,2,30,101,184,145,194,162,17,22,122,187,140,94,7,158,9,226,200,168,51,156]))throw new Error("Unexpected HelloRetryRequest");r.expectUint8(e.length,0),r.expectBytes(e,0),r.expectUint16(4865,0),r.expectUint8(0,0);let[a,o]=r.expectLengthUint16(0);for(;o()>0;){let h=r.readUint16(0),[d]=r.expectLengthUint16(0);if(h===43)r.expectUint16(772,0),n=!0;else if(h===51)r.expectUint16(23,0),r.expectUint16(65),t=r.readBytes(65);else throw new Error(`Unexpected extension 0x${N([h])}`);d()}if(a(),s(),i(),n!==!0)throw new Error("No TLS version provided");if(t===void 0)throw new Error("No key provided");return t}var tt=1<<14;async function et(r,e){let n=await r(5);if(n===void 0)return;if(n.length<5)throw new Error("TLS record header truncated");let i=new f(n),s=i.readUint8();if(s<20||s>24)throw new Error(`Illegal TLS record type 0x${s.toString(16)}`);if(e!==void 0&&s!==e)throw new Error(`Unexpected TLS record type 0x${s.toString(16).padStart(2,"0")} (expected 0x${e.toString(16).padStart(2,"0")})`);let c=i.readUint16(0);if([769,770,771].indexOf(c)<0)throw new Error(`Unsupported TLS record version 0x${c.toString(16).padStart(4,"0")}`);let a=i.readUint16(0);if(a>tt)throw new Error(`Record too long: ${a} bytes`);let o=await r(a);if(o===void 0||o.length<a)throw new Error("TLS record content truncated");return{headerData:n,header:i,type:s,version:c,length:a,content:o}}async function dt(r,e,t){let n=await et(r,23);if(n===void 0)return;let i=new f(n.content),[s]=i.expectLength(i.remaining());i.skip(n.length-16,0),i.skip(16,0),s();let c=await e.process(n.content,16,n.headerData),a=c.length-1;for(;c[a]===0;)a-=1;if(a<0)throw new Error("Decrypted message is all has no record type indicator (all zeroes)");let o=c[a],h=c.subarray(0,a);if(!(o===21&&h.length===2&&h[0]===1&&h[1]===0)){if(t!==void 0&&o!==t)throw new Error(`Unexpected TLS record type 0x${o.toString(16).padStart(2,"0")} (expected 0x${t.toString(16).padStart(2,"0")})`);return h}}async function Zt(r,e,t){let n=p(r,[t]),i=5,a=n.length+16,o=new f(i+a);o.writeUint8(23,0),o.writeUint16(771,0),o.writeUint16(a,`${a} bytes follow`);let[h]=o.expectLength(a),d=o.array(),y=await e.process(n,16,d);return o.writeBytes(y.subarray(0,y.length-16)),o.writeBytes(y.subarray(y.length-16)),h(),o.array()}async function lt(r,e,t){let n=Math.ceil(r.length/tt),i=[];for(let s=0;s<n;s++){let c=r.subarray(s*tt,(s+1)*tt),a=await Zt(c,e,t);i.push(a)}return i}var wt=new TextEncoder;async function gt(r,e,t){let n=await crypto.subtle.importKey("raw",r,{name:"HMAC",hash:{name:`SHA-${t}`}},!1,["sign"]);var i=new Uint8Array(await crypto.subtle.sign("HMAC",n,e));return i}async function Wt(r,e,t,n){let i=n>>3,s=Math.ceil(t/i),c=new Uint8Array(s*i),a=await crypto.subtle.importKey("raw",r,{name:"HMAC",hash:{name:`SHA-${n}`}},!1,["sign"]),o=new Uint8Array(0);for(let h=0;h<s;h++){let d=p(o,e,[h+1]),y=await crypto.subtle.sign("HMAC",a,d),g=new Uint8Array(y);c.set(g,i*h),o=g}return c.subarray(0,t)}var xt=wt.encode("tls13 ");async function A(r,e,t,n,i){let s=wt.encode(e),c=p([(n&65280)>>8,n&255],[xt.length+s.length],xt,s,[t.length],t);return Wt(r,c,n,i)}async function St(r,e,t,n,i){let s=n>>3,c=new Uint8Array(s),a=await crypto.subtle.importKey("raw",r,{name:"ECDH",namedCurve:"P-256"},!1,[]),o=await crypto.subtle.deriveBits({name:"ECDH",public:a},e,256),h=new Uint8Array(o),d=await crypto.subtle.digest("SHA-256",t),y=new Uint8Array(d),g=await gt(new Uint8Array(1),c,n),u=await crypto.subtle.digest(`SHA-${n}`,new Uint8Array(0)),m=new Uint8Array(u),w=await A(g,"derived",m,s,n),S=await gt(w,h,n),l=await A(S,"c hs traffic",y,s,n),U=await A(S,"s hs traffic",y,s,n),B=await A(l,"key",new Uint8Array(0),i,n),K=await A(U,"key",new Uint8Array(0),i,n),R=await A(l,"iv",new Uint8Array(0),12,n),M=await A(U,"iv",new Uint8Array(0),12,n);return{serverHandshakeKey:K,serverHandshakeIV:M,clientHandshakeKey:B,clientHandshakeIV:R,handshakeSecret:S,clientSecret:l,serverSecret:U}}async function Ut(r,e,t,n){let i=t>>3,s=new Uint8Array(i),c=await crypto.subtle.digest(`SHA-${t}`,new Uint8Array(0)),a=new Uint8Array(c),o=await A(r,"derived",a,i,t),h=await gt(o,s,t),d=await A(h,"c ap traffic",e,i,t),y=await A(h,"s ap traffic",e,i,t),g=await A(d,"key",new Uint8Array(0),n,t),u=await A(y,"key",new Uint8Array(0),n,t),m=await A(d,"iv",new Uint8Array(0),12,t),w=await A(y,"iv",new Uint8Array(0),12,t);return{serverApplicationKey:u,serverApplicationIV:w,clientApplicationKey:g,clientApplicationIV:m}}var q=class{mode;key;initialIv;ivLength;currentIv;currentIvDataView;initialIvLast32;recordsDecrypted=0;constructor(e,t,n){this.mode=e,this.key=t,this.initialIv=n,this.ivLength=n.length,this.currentIv=n.slice(),this.currentIvDataView=new DataView(this.currentIv.buffer,this.currentIv.byteOffset,this.currentIv.byteLength),this.initialIvLast32=this.currentIvDataView.getUint32(this.ivLength-4)}async process(e,t,n){if(this.recordsDecrypted===1073741824)throw new Error("Cannot encrypt/decrypt any more records");let i=this.initialIvLast32^this.recordsDecrypted;this.currentIvDataView.setUint32(this.ivLength-4,i),this.recordsDecrypted+=1;let s=t<<3,c={name:"AES-GCM",iv:this.currentIv,tagLength:s,additionalData:n},a=await crypto.subtle[this.mode](c,this.key,e);return new Uint8Array(a)}};function nt(r){return r>64&&r<91?r-65:r>96&&r<123?r-71:r>47&&r<58?r+4:r===43?62:r===47?63:r===61?64:void 0}function bt(r){let e=r.length,t=0,n=0,i=64,s=64,c=64,a=64,o=new Uint8Array(e*.75);for(;t<e;)i=nt(r.charCodeAt(t++)),s=nt(r.charCodeAt(t++)),c=nt(r.charCodeAt(t++)),a=nt(r.charCodeAt(t++)),o[n++]=i<<2|s>>4,o[n++]=(s&15)<<4|c>>2,o[n++]=(c&3)<<6|a;let h=s===64?0:c===64?2:a===64?1:0;return o.subarray(0,n-h)}var H=class extends f{readASN1Length(e){let t=this.readUint8();if(t<128)return t;let n=t&127,i=0;if(n===1)return this.readUint8(i);if(n===2)return this.readUint16(i);if(n===3)return this.readUint24(i);if(n===4)return this.readUint32(i);throw new Error(`ASN.1 length fields are only supported up to 4 bytes (this one is ${n} bytes)`)}expectASN1Length(e){let t=this.readASN1Length(e);return this.expectLength(t)}readASN1OID(){let[e,t]=this.expectASN1Length(0),n=this.readUint8(),i=`${Math.floor(n/40)}.${n%40}`;for(;t()>0;){let s=0;for(;;){let c=this.readUint8();if(s<<=7,s+=c&127,c<128)break}i+=`.${s}`}return e(),i}readASN1Boolean(){let[e,t]=this.expectASN1Length(0),n=t();if(n!==1)throw new Error(`Boolean has weird length: ${n}`);let i=this.readUint8(),s;if(i===255)s=!0;else if(i===0)s=!1;else throw new Error(`Boolean has weird value: 0x${N([i])}`);return e(),s}readASN1UTCTime(){let[e,t]=this.expectASN1Length(0),i=this.readUTF8String(t()).match(/^(\d\d)(\d\d)(\d\d)(\d\d)(\d\d)(\d\d)Z$/);if(!i)throw new Error("Unrecognised UTC time format in certificate validity");let[,s,c,a,o,h,d]=i,y=parseInt(s,10),g=y+(y>=50?1900:2e3),u=new Date(`${g}-${c}-${a}T${o}:${h}:${d}Z`);return e(),u}readASN1BitString(){let[e,t]=this.expectASN1Length(0),n=this.readUint8(0),i=t(),s=this.readBytes(i);if(n>7)throw new Error(`Invalid right pad value: ${n}`);if(n>0){let c=8-n;for(let a=i-1;a>0;a--)s[a]=255&s[a-1]<<c|s[a]>>>n;s[0]=s[0]>>>n}return e(),s}};var it=1,$=2,x=48,Xt=49,P=6,_t=19,te=12,mt=23,rt=5,V=4,st=3,Ct=163,G=128;var ee={"2.5.4.6":"C","2.5.4.10":"O","2.5.4.11":"OU","2.5.4.3":"CN","2.5.4.7":"L","2.5.4.8":"ST","2.5.4.12":"T","2.5.4.42":"GN","2.5.4.43":"I","2.5.4.4":"SN","1.2.840.113549.1.9.1":"E-mail"};function Et(r){let{length:e}=r;if(e>4)throw new Error(`Bit string length ${e} would overflow JS bit operators`);let t=0,n=0;for(let i=r.length-1;i>=0;i--)t|=r[i]<<n,n+=8;return t}function ut(r,e){let t={};r.expectUint8(x,0);let[n,i]=r.expectASN1Length(0);for(;i()>0;){r.expectUint8(Xt,0);let[s]=r.expectASN1Length(0);r.expectUint8(x,0);let[c]=r.expectASN1Length(0);r.expectUint8(P,0);let a=r.readASN1OID(),o=ee[a]??a,h=r.readUint8();if(h!==_t){if(h!==te)throw new Error(`Unexpected item type in certificate ${e}: 0x${N([h])}`)}let[d,y]=r.expectASN1Length(0),g=r.readUTF8String(y());if(d(),c(),s(),t[o]!==void 0)throw new Error(`Duplicate OID ${o} in certificate ${e}`);t[o]=g}return n(),t}function vt(r,e=0){let t=[],[n,i]=r.expectASN1Length(0);for(;i()>0;){let s=r.readUint8(0),[c,a]=r.expectASN1Length(0),o;s===(e|2)?o=r.readUTF8String(a()):o=r.readBytes(a()),t.push({name:o,type:s}),c()}return n(),t}function It(r){let e={"1.2.840.113549.1.1.1":{name:"RSAES-PKCS1-v1_5"},"1.2.840.113549.1.1.5":{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-1"}},"1.2.840.113549.1.1.11":{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},"1.2.840.113549.1.1.12":{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-384"}},"1.2.840.113549.1.1.13":{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-512"}},"1.2.840.113549.1.1.10":{name:"RSA-PSS"},"1.2.840.113549.1.1.7":{name:"RSA-OAEP"},"1.2.840.10045.2.1":{name:"ECDSA",hash:{name:"SHA-1"}},"1.2.840.10045.4.1":{name:"ECDSA",hash:{name:"SHA-1"}},"1.2.840.10045.4.3.2":{name:"ECDSA",hash:{name:"SHA-256"}},"1.2.840.10045.4.3.3":{name:"ECDSA",hash:{name:"SHA-384"}},"1.2.840.10045.4.3.4":{name:"ECDSA",hash:{name:"SHA-512"}},"1.3.133.16.840.63.0.2":{name:"ECDH",kdf:"SHA-1"},"1.3.132.1.11.1":{name:"ECDH",kdf:"SHA-256"},"1.3.132.1.11.2":{name:"ECDH",kdf:"SHA-384"},"1.3.132.1.11.3":{name:"ECDH",kdf:"SHA-512"},"2.16.840.1.101.3.4.1.2":{name:"AES-CBC",length:128},"2.16.840.1.101.3.4.1.22":{name:"AES-CBC",length:192},"2.16.840.1.101.3.4.1.42":{name:"AES-CBC",length:256},"2.16.840.1.101.3.4.1.6":{name:"AES-GCM",length:128},"2.16.840.1.101.3.4.1.26":{name:"AES-GCM",length:192},"2.16.840.1.101.3.4.1.46":{name:"AES-GCM",length:256},"2.16.840.1.101.3.4.1.4":{name:"AES-CFB",length:128},"2.16.840.1.101.3.4.1.24":{name:"AES-CFB",length:192},"2.16.840.1.101.3.4.1.44":{name:"AES-CFB",length:256},"2.16.840.1.101.3.4.1.5":{name:"AES-KW",length:128},"2.16.840.1.101.3.4.1.25":{name:"AES-KW",length:192},"2.16.840.1.101.3.4.1.45":{name:"AES-KW",length:256},"1.2.840.113549.2.7":{name:"HMAC",hash:{name:"SHA-1"}},"1.2.840.113549.2.9":{name:"HMAC",hash:{name:"SHA-256"}},"1.2.840.113549.2.10":{name:"HMAC",hash:{name:"SHA-384"}},"1.2.840.113549.2.11":{name:"HMAC",hash:{name:"SHA-512"}},"1.2.840.113549.1.9.16.3.5":{name:"DH"},"1.3.14.3.2.26":{name:"SHA-1"},"2.16.840.1.101.3.4.2.1":{name:"SHA-256"},"2.16.840.1.101.3.4.2.2":{name:"SHA-384"},"2.16.840.1.101.3.4.2.3":{name:"SHA-512"},"1.2.840.113549.1.5.12":{name:"PBKDF2"},"1.2.840.10045.3.1.7":{name:"P-256"},"1.3.132.0.34":{name:"P-384"},"1.3.132.0.35":{name:"P-521"}}[r];if(e===void 0)throw new Error(`Unsupported algorithm identifier: ${r}`);return e}function Dt(r,e=[]){return Object.values(r).forEach(t=>{typeof t=="string"?e=[...e,t]:e=Dt(t,e)}),e}function Lt(r){return Dt(r).join(" / ")}var ne=["digitalSignature","nonRepudiation","keyEncipherment","dataEncipherment","keyAgreement","keyCertSign","cRLSign","encipherOnly","decipherOnly"],Z=class{serialNumber;algorithm;issuer;validityPeriod;subject;publicKey;signature;keyUsage;subjectAltNames;extKeyUsage;authorityKeyIdentifier;subjectKeyIdentifier;basicConstraints;signedData;constructor(e){let t=e instanceof H?e:new H(e);t.expectUint8(x,0);let[n]=t.expectASN1Length(0),i=t.offset;t.expectUint8(x,0);let[s]=t.expectASN1Length(0);t.expectBytes([160,3,2,1,2],0),t.expectUint8($,0);let[c,a]=t.expectASN1Length(0);this.serialNumber=t.subarray(a()),c(),t.expectUint8(x,0);let[o,h]=t.expectASN1Length(0);t.expectUint8(P,0),this.algorithm=t.readASN1OID(),h()>0&&(t.expectUint8(rt,0),t.expectUint8(0,0)),o(),this.issuer=ut(t,"issuer"),t.expectUint8(x,0);let[d]=t.expectASN1Length(0);t.expectUint8(mt,0);let y=t.readASN1UTCTime();t.expectUint8(mt,0);let g=t.readASN1UTCTime();this.validityPeriod={notBefore:y,notAfter:g},d(),this.subject=ut(t,"subject");let u=t.offset;t.expectUint8(x,0);let[m]=t.expectASN1Length(0);t.expectUint8(x,0);let[w,S]=t.expectASN1Length(0),l=[];for(;S()>0;){let F=t.readUint8();if(F===P){let O=t.readASN1OID();l.push(O)}else F===rt&&t.expectUint8(0,0)}w(),t.expectUint8(st,0);let U=t.readASN1BitString();this.publicKey={identifiers:l,data:U,all:t.data.subarray(u,t.offset)},m(),t.expectUint8(Ct,0);let[B]=t.expectASN1Length();t.expectUint8(x,0);let[K,R]=t.expectASN1Length(0);for(;R()>0;){t.expectUint8(x,0);let[F,O]=t.expectASN1Length();t.expectUint8(P,0);let k=t.readASN1OID();if(k==="2.5.29.17"){t.expectUint8(V,0);let[v]=t.expectASN1Length(0);t.expectUint8(x,0);let b=vt(t,G);this.subjectAltNames=b.filter(C=>C.type===(2|G)).map(C=>C.name),v()}else if(k==="2.5.29.15"){t.expectUint8(it,0);let v=t.readASN1Boolean();t.expectUint8(V,0);let[b]=t.expectASN1Length(0);t.expectUint8(st,0);let C=t.readASN1BitString(),I=Et(C),E=new Set(ne.filter((D,L)=>I&1<<L));b(),this.keyUsage={critical:v,usages:E}}else if(k==="2.5.29.37"){this.extKeyUsage={},t.expectUint8(V,0);let[v]=t.expectASN1Length(0);t.expectUint8(x,0);let[b,C]=t.expectASN1Length(0);for(;C()>0;){t.expectUint8(P,0);let I=t.readASN1OID();I==="1.3.6.1.5.5.7.3.1"&&(this.extKeyUsage.serverTls=!0),I==="1.3.6.1.5.5.7.3.2"&&(this.extKeyUsage.clientTls=!0)}b(),v()}else if(k==="2.5.29.35"){t.expectUint8(V,0);let[v]=t.expectASN1Length(0);t.expectUint8(x,0);let[b,C]=t.expectASN1Length(0);for(;C()>0;){let I=t.readUint8();if(I===(G|0)){let[E,D]=t.expectASN1Length(0);this.authorityKeyIdentifier=t.readBytes(D()),E()}else if(I===(G|1)||I===(G|2)){let[E,D]=t.expectASN1Length(0);t.skip(D(),0),E()}else throw new Error("Unexpected data type in authorityKeyIdentifier certificate extension")}b(),v()}else if(k==="2.5.29.14"){t.expectUint8(V,0);let[v]=t.expectASN1Length(0);t.expectUint8(V,0);let[b,C]=t.expectASN1Length(0);this.subjectKeyIdentifier=t.readBytes(C()),b(),v()}else if(k==="2.5.29.19"){t.expectUint8(it,0);let v=t.readASN1Boolean();t.expectUint8(V,0);let[b]=t.expectASN1Length(0);t.expectUint8(x,0);let[C,I]=t.expectASN1Length(),E;I()>0&&(t.expectUint8(it,0),E=t.readASN1Boolean());let D;if(I()>0){t.expectUint8($,0);let L=t.readASN1Length(0);if(D=L===1?t.readUint8():L===2?t.readUint16():L===3?t.readUint24():void 0,D===void 0)throw new Error("Too many bytes in max path length in certificate basicConstraints")}C(),b(),this.basicConstraints={critical:v,ca:E,pathLength:D}}else t.skip(O(),0);F()}K(),B(),s(),this.signedData=t.data.subarray(i,t.offset),t.expectUint8(x,0);let[M,j]=t.expectASN1Length(0);t.expectUint8(P,0);let T=t.readASN1OID();if(j()>0&&(t.expectUint8(rt,0),t.expectUint8(0,0)),M(),T!==this.algorithm)throw new Error(`Certificate specifies different signature algorithms inside (${this.algorithm}) and out (${T})`);t.expectUint8(st,0),this.signature=t.readASN1BitString(),n()}static fromPEM(e){let t="[A-Z0-9 ]+",n=new RegExp(`-{5}BEGIN ${t}-{5}([a-zA-Z0-9=+\\/\\n\\r]+)-{5}END ${t}-{5}`,"g"),i=[],s=null;for(;s=n.exec(e);){let c=s[1].replace(/[\r\n]/g,""),a=bt(c),o=new this(a);i.push(o)}return i}subjectAltNameMatchingHost(e){let t=/[.][^.]+[.][^.]+$/;return(this.subjectAltNames??[]).find(n=>{let i=n,s=e;if(t.test(e)&&t.test(i)&&i.startsWith("*.")&&(i=i.slice(1),s=s.slice(s.indexOf("."))),i===s)return!0})}isValidAtMoment(e=new Date){return e>=this.validityPeriod.notBefore&&e<=this.validityPeriod.notAfter}description(){return"subject: "+Object.entries(this.subject).map(e=>e.join("=")).join(", ")+(this.subjectAltNames?`
subject alt names: `+this.subjectAltNames.join(", "):"")+(this.subjectKeyIdentifier?`
subject key id: ${N(this.subjectKeyIdentifier," ")}`:"")+`
issuer: `+Object.entries(this.issuer).map(e=>e.join("=")).join(", ")+(this.authorityKeyIdentifier?`
authority key id: ${N(this.authorityKeyIdentifier," ")}`:"")+`
validity: `+this.validityPeriod.notBefore.toISOString()+" \u2013 "+this.validityPeriod.notAfter.toISOString()+` (${this.isValidAtMoment()?"currently valid":"not valid"})`+(this.keyUsage?`
key usage (${this.keyUsage.critical?"critical":"non-critical"}): `+[...this.keyUsage.usages].join(", "):"")+(this.extKeyUsage?`
extended key usage: TLS server \u2014\xA0${this.extKeyUsage.serverTls}, TLS client \u2014\xA0${this.extKeyUsage.clientTls}`:"")+(this.basicConstraints?`
basic constraints (${this.basicConstraints.critical?"critical":"non-critical"}): CA \u2014\xA0${this.basicConstraints.ca}, path length \u2014 ${this.basicConstraints.pathLength}`:"")+`
signature algorithm: `+Lt(It(this.algorithm))}toJSON(){return{serialNumber:[...this.serialNumber],algorithm:this.algorithm,issuer:this.issuer,validityPeriod:{notBefore:this.validityPeriod.notBefore.toISOString(),notAfter:this.validityPeriod.notAfter.toISOString()},subject:this.subject,publicKey:{identifiers:this.publicKey.identifiers,data:[...this.publicKey.data],all:[...this.publicKey.all]},signature:[...this.signature],keyUsage:{critical:this.keyUsage?.critical,usages:[...this.keyUsage?.usages??[]]},subjectAltNames:this.subjectAltNames,extKeyUsage:this.extKeyUsage,authorityKeyIdentifier:this.authorityKeyIdentifier&&[...this.authorityKeyIdentifier],subjectKeyIdentifier:this.subjectKeyIdentifier&&[...this.subjectKeyIdentifier],basicConstraints:this.basicConstraints,signedData:[...this.signedData]}}},Y=class extends Z{};async function at(r,e,t,n,i){r.expectUint8(x,0);let[s]=r.expectASN1Length(0);r.expectUint8($,0);let[c,a]=r.expectASN1Length(0),o=r.readBytes(a());c(),r.expectUint8($,0);let[h,d]=r.expectASN1Length(0),y=r.readBytes(d());h(),s();let g=(l,U)=>l.length>U?l.subarray(l.length-U):l.length<U?p(new Uint8Array(U-l.length),l):l,u=n==="P-256"?32:48,m=p(g(o,u),g(y,u)),w=await crypto.subtle.importKey("spki",e,{name:"ECDSA",namedCurve:n},!1,["verify"]);if(await crypto.subtle.verify({name:"ECDSA",hash:i},w,m,t)!==!0)throw new Error("ECDSA-SECP256R1-SHA256 certificate verify failed")}var Bt=`-----BEGIN CERTIFICATE-----
MIIFazCCA1OgAwIBAgIRAIIQz7DSQONZRGPgu2OCiwAwDQYJKoZIhvcNAQELBQAw
TzELMAkGA1UEBhMCVVMxKTAnBgNVBAoTIEludGVybmV0IFNlY3VyaXR5IFJlc2Vh
cmNoIEdyb3VwMRUwEwYDVQQDEwxJU1JHIFJvb3QgWDEwHhcNMTUwNjA0MTEwNDM4
WhcNMzUwNjA0MTEwNDM4WjBPMQswCQYDVQQGEwJVUzEpMCcGA1UEChMgSW50ZXJu
ZXQgU2VjdXJpdHkgUmVzZWFyY2ggR3JvdXAxFTATBgNVBAMTDElTUkcgUm9vdCBY
MTCCAiIwDQYJKoZIhvcNAQEBBQADggIPADCCAgoCggIBAK3oJHP0FDfzm54rVygc
h77ct984kIxuPOZXoHj3dcKi/vVqbvYATyjb3miGbESTtrFj/RQSa78f0uoxmyF+
0TM8ukj13Xnfs7j/EvEhmkvBioZxaUpmZmyPfjxwv60pIgbz5MDmgK7iS4+3mX6U
A5/TR5d8mUgjU+g4rk8Kb4Mu0UlXjIB0ttov0DiNewNwIRt18jA8+o+u3dpjq+sW
T8KOEUt+zwvo/7V3LvSye0rgTBIlDHCNAymg4VMk7BPZ7hm/ELNKjD+Jo2FR3qyH
B5T0Y3HsLuJvW5iB4YlcNHlsdu87kGJ55tukmi8mxdAQ4Q7e2RCOFvu396j3x+UC
B5iPNgiV5+I3lg02dZ77DnKxHZu8A/lJBdiB3QW0KtZB6awBdpUKD9jf1b0SHzUv
KBds0pjBqAlkd25HN7rOrFleaJ1/ctaJxQZBKT5ZPt0m9STJEadao0xAH0ahmbWn
OlFuhjuefXKnEgV4We0+UXgVCwOPjdAvBbI+e0ocS3MFEvzG6uBQE3xDk3SzynTn
jh8BCNAw1FtxNrQHusEwMFxIt4I7mKZ9YIqioymCzLq9gwQbooMDQaHWBfEbwrbw
qHyGO0aoSCqI3Haadr8faqU9GY/rOPNk3sgrDQoo//fb4hVC1CLQJ13hef4Y53CI
rU7m2Ys6xt0nUW7/vGT1M0NPAgMBAAGjQjBAMA4GA1UdDwEB/wQEAwIBBjAPBgNV
HRMBAf8EBTADAQH/MB0GA1UdDgQWBBR5tFnme7bl5AFzgAiIyBpY9umbbjANBgkq
hkiG9w0BAQsFAAOCAgEAVR9YqbyyqFDQDLHYGmkgJykIrGF1XIpu+ILlaS/V9lZL
ubhzEFnTIZd+50xx+7LSYK05qAvqFyFWhfFQDlnrzuBZ6brJFe+GnY+EgPbk6ZGQ
3BebYhtF8GaV0nxvwuo77x/Py9auJ/GpsMiu/X1+mvoiBOv/2X/qkSsisRcOj/KK
NFtY2PwByVS5uCbMiogziUwthDyC3+6WVwW6LLv3xLfHTjuCvjHIInNzktHCgKQ5
ORAzI4JMPJ+GslWYHb4phowim57iaztXOoJwTdwJx4nLCgdNbOhdjsnvzqvHu7Ur
TkXWStAmzOVyyghqpZXjFaH3pO3JLF+l+/+sKAIuvtd7u+Nxe5AW0wdeRlN8NwdC
jNPElpzVmbUq4JUagEiuTDkHzsxHpFKVK7q4+63SM1N95R1NbdWhscdCb+ZAJzVc
oyi3B43njTOQ5yOf+1CceWxG1bQVs5ZufpsMljq4Ui0/1lvh+wjChP4kqKOJ2qxq
4RgqsahDYVvTH9w7jXbyLeiNdd8XM2w9U/t7y0Ff/9yi0GE44Za4rF2LN9d11TPA
mRGunUHBcnWEvgJBQl9nJEiU0Zsnvgc/ubhPgXRR4Xq37Z0j4r7g1SgEEzwxA57d
emyPxgcYxn/eR44/KJ4EBs+lVDR3veyJm+kXQ99b21/+jh5Xos1AnX5iItreGCc=
-----END CERTIFICATE-----
`;var Nt=`-----BEGIN CERTIFICATE-----
MIICGzCCAaGgAwIBAgIQQdKd0XLq7qeAwSxs6S+HUjAKBggqhkjOPQQDAzBPMQsw
CQYDVQQGEwJVUzEpMCcGA1UEChMgSW50ZXJuZXQgU2VjdXJpdHkgUmVzZWFyY2gg
R3JvdXAxFTATBgNVBAMTDElTUkcgUm9vdCBYMjAeFw0yMDA5MDQwMDAwMDBaFw00
MDA5MTcxNjAwMDBaME8xCzAJBgNVBAYTAlVTMSkwJwYDVQQKEyBJbnRlcm5ldCBT
ZWN1cml0eSBSZXNlYXJjaCBHcm91cDEVMBMGA1UEAxMMSVNSRyBSb290IFgyMHYw
EAYHKoZIzj0CAQYFK4EEACIDYgAEzZvVn4CDCuwJSvMWSj5cz3es3mcFDR0HttwW
+1qLFNvicWDEukWVEYmO6gbf9yoWHKS5xcUy4APgHoIYOIvXRdgKam7mAHf7AlF9
ItgKbppbd9/w+kHsOdx1ymgHDB/qo0IwQDAOBgNVHQ8BAf8EBAMCAQYwDwYDVR0T
AQH/BAUwAwEB/zAdBgNVHQ4EFgQUfEKWrt5LSDv6kviejM9ti6lyN5UwCgYIKoZI
zj0EAwMDaAAwZQIwe3lORlCEwkSHRhtFcP9Ymd70/aTSVaYgLXTWNLxBo1BfASdW
tL4ndQavEi51mI38AjEAi/V3bNTIZargCyzuFJ0nN6T5U6VR5CmD1/iQMVtCnwr1
/q4AaOeMSQ+2b1tbFfLn
-----END CERTIFICATE-----
`;var Tt=`-----BEGIN CERTIFICATE-----
MIIDdzCCAl+gAwIBAgIEAgAAuTANBgkqhkiG9w0BAQUFADBaMQswCQYDVQQGEwJJ
RTESMBAGA1UEChMJQmFsdGltb3JlMRMwEQYDVQQLEwpDeWJlclRydXN0MSIwIAYD
VQQDExlCYWx0aW1vcmUgQ3liZXJUcnVzdCBSb290MB4XDTAwMDUxMjE4NDYwMFoX
DTI1MDUxMjIzNTkwMFowWjELMAkGA1UEBhMCSUUxEjAQBgNVBAoTCUJhbHRpbW9y
ZTETMBEGA1UECxMKQ3liZXJUcnVzdDEiMCAGA1UEAxMZQmFsdGltb3JlIEN5YmVy
VHJ1c3QgUm9vdDCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAKMEuyKr
mD1X6CZymrV51Cni4eiVgLGw41uOKymaZN+hXe2wCQVt2yguzmKiYv60iNoS6zjr
IZ3AQSsBUnuId9Mcj8e6uYi1agnnc+gRQKfRzMpijS3ljwumUNKoUMMo6vWrJYeK
mpYcqWe4PwzV9/lSEy/CG9VwcPCPwBLKBsua4dnKM3p31vjsufFoREJIE9LAwqSu
XmD+tqYF/LTdB1kC1FkYmGP1pWPgkAx9XbIGevOF6uvUA65ehD5f/xXtabz5OTZy
dc93Uk3zyZAsuT3lySNTPx8kmCFcB5kpvcY67Oduhjprl3RjM71oGDHweI12v/ye
jl0qhqdNkNwnGjkCAwEAAaNFMEMwHQYDVR0OBBYEFOWdWTCCR1jMrPoIVDaGezq1
BE3wMBIGA1UdEwEB/wQIMAYBAf8CAQMwDgYDVR0PAQH/BAQDAgEGMA0GCSqGSIb3
DQEBBQUAA4IBAQCFDF2O5G9RaEIFoN27TyclhAO992T9Ldcw46QQF+vaKSm2eT92
9hkTI7gQCvlYpNRhcL0EYWoSihfVCr3FvDB81ukMJY2GQE/szKN+OMY3EU/t3Wgx
jkzSswF07r51XgdIGn9w/xZchMB5hbgF/X++ZRGjD8ACtPhSNzkE1akxehi/oCr0
Epn3o0WC4zxe9Z2etciefC7IpJ5OCBRLbf1wbWsaY71k5h+3zvDyny67G7fyUIhz
ksLi4xaNmjICq44Y3ekQEe5+NauQrz4wlHrQMz2nZQ/1/I6eYs9HRCwBXbsdtTLS
R9I4LtD+gdwyah617jzV/OeBHRnDJELqYzmp
-----END CERTIFICATE-----`;var kt=`-----BEGIN CERTIFICATE-----\r
MIIDdTCCAl2gAwIBAgILBAAAAAABFUtaw5QwDQYJKoZIhvcNAQEFBQAwVzELMAkG\r
A1UEBhMCQkUxGTAXBgNVBAoTEEdsb2JhbFNpZ24gbnYtc2ExEDAOBgNVBAsTB1Jv\r
b3QgQ0ExGzAZBgNVBAMTEkdsb2JhbFNpZ24gUm9vdCBDQTAeFw05ODA5MDExMjAw\r
MDBaFw0yODAxMjgxMjAwMDBaMFcxCzAJBgNVBAYTAkJFMRkwFwYDVQQKExBHbG9i\r
YWxTaWduIG52LXNhMRAwDgYDVQQLEwdSb290IENBMRswGQYDVQQDExJHbG9iYWxT\r
aWduIFJvb3QgQ0EwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDaDuaZ\r
jc6j40+Kfvvxi4Mla+pIH/EqsLmVEQS98GPR4mdmzxzdzxtIK+6NiY6arymAZavp\r
xy0Sy6scTHAHoT0KMM0VjU/43dSMUBUc71DuxC73/OlS8pF94G3VNTCOXkNz8kHp\r
1Wrjsok6Vjk4bwY8iGlbKk3Fp1S4bInMm/k8yuX9ifUSPJJ4ltbcdG6TRGHRjcdG\r
snUOhugZitVtbNV4FpWi6cgKOOvyJBNPc1STE4U6G7weNLWLBYy5d4ux2x8gkasJ\r
U26Qzns3dLlwR5EiUWMWea6xrkEmCMgZK9FGqkjWZCrXgzT/LCrBbBlDSgeF59N8\r
9iFo7+ryUp9/k5DPAgMBAAGjQjBAMA4GA1UdDwEB/wQEAwIBBjAPBgNVHRMBAf8E\r
BTADAQH/MB0GA1UdDgQWBBRge2YaRQ2XyolQL30EzTSo//z9SzANBgkqhkiG9w0B\r
AQUFAAOCAQEA1nPnfE920I2/7LqivjTFKDK1fPxsnCwrvQmeU79rXqoRSLblCKOz\r
yj1hTdNGCbM+w6DjY1Ub8rrvrTnhQ7k4o+YviiY776BQVvnGCv04zcQLcFGUl5gE\r
38NflNUVyRRBnMRddWQVDf9VMOyGj/8N7yy5Y0b2qvzfvGn9LhJIZJrglfCm7ymP\r
AbEVtQwdpf5pLGkkeB6zpxxxYu7KyJesF12KwvhHhm4qxFYxldBniYUr+WymXUad\r
DKqC5JlR3XC321Y9YeRq4VzW9v493kHMB65jUr9TU/Qr6cf9tveCX4XSQRjbgbME\r
HMUfpIBvFSDJ3gyICh3WZlXi/EjJKSZp4A==\r
-----END CERTIFICATE-----\r
`;var Kt=`-----BEGIN CERTIFICATE-----\r
MIIDXzCCAkegAwIBAgILBAAAAAABIVhTCKIwDQYJKoZIhvcNAQELBQAwTDEgMB4G\r
A1UECxMXR2xvYmFsU2lnbiBSb290IENBIC0gUjMxEzARBgNVBAoTCkdsb2JhbFNp\r
Z24xEzARBgNVBAMTCkdsb2JhbFNpZ24wHhcNMDkwMzE4MTAwMDAwWhcNMjkwMzE4\r
MTAwMDAwWjBMMSAwHgYDVQQLExdHbG9iYWxTaWduIFJvb3QgQ0EgLSBSMzETMBEG\r
A1UEChMKR2xvYmFsU2lnbjETMBEGA1UEAxMKR2xvYmFsU2lnbjCCASIwDQYJKoZI\r
hvcNAQEBBQADggEPADCCAQoCggEBAMwldpB5BngiFvXAg7aEyiie/QV2EcWtiHL8\r
RgJDx7KKnQRfJMsuS+FggkbhUqsMgUdwbN1k0ev1LKMPgj0MK66X17YUhhB5uzsT\r
gHeMCOFJ0mpiLx9e+pZo34knlTifBtc+ycsmWQ1z3rDI6SYOgxXG71uL0gRgykmm\r
KPZpO/bLyCiR5Z2KYVc3rHQU3HTgOu5yLy6c+9C7v/U9AOEGM+iCK65TpjoWc4zd\r
QQ4gOsC0p6Hpsk+QLjJg6VfLuQSSaGjlOCZgdbKfd/+RFO+uIEn8rUAVSNECMWEZ\r
XriX7613t2Saer9fwRPvm2L7DWzgVGkWqQPabumDk3F2xmmFghcCAwEAAaNCMEAw\r
DgYDVR0PAQH/BAQDAgEGMA8GA1UdEwEB/wQFMAMBAf8wHQYDVR0OBBYEFI/wS3+o\r
LkUkrk1Q+mOai97i3Ru8MA0GCSqGSIb3DQEBCwUAA4IBAQBLQNvAUKr+yAzv95ZU\r
RUm7lgAJQayzE4aGKAczymvmdLm6AC2upArT9fHxD4q/c2dKg8dEe3jgr25sbwMp\r
jjM5RcOO5LlXbKr8EpbsU8Yt5CRsuZRj+9xTaGdWPoO4zzUhw8lo/s7awlOqzJCK\r
6fBdRoyV3XpYKBovHd7NADdBj+1EbddTKJd+82cEHhXXipa0095MJ6RMG3NzdvQX\r
mcIfeg7jLQitChws/zyrVQ4PkX4268NXSb7hLi18YIvDQVETI53O9zJrlAGomecs\r
Mx86OyXShkDOOyyGeMlhLxS67ttVb9+E7gUJTb0o2HLO02JQZR7rkpeDMdmztcpH\r
WD9f\r
-----END CERTIFICATE-----\r
`;function Rt(){return Y.fromPEM(Bt+Nt+Tt+kt+Kt)}async function Ht(r,e){for(let a of r);let t=r[0];if(t.subjectAltNameMatchingHost(e)===void 0)throw new Error(`No matching subjectAltName for ${e}`);if(!t.isValidAtMoment())throw new Error("End-user certificate is not valid now");if(!t.extKeyUsage?.serverTls)throw new Error("End-user certificate has no TLS server extKeyUsage");let s=Rt(),c=!1;for(let a of s);for(let a=0,o=r.length;a<o;a++){let h=r[a],d=h.authorityKeyIdentifier;if(d===void 0)throw new Error("Certificates without an authorityKeyIdentifier are not supported");let y=s.find(m=>m.subjectKeyIdentifier!==void 0&&Q(m.subjectKeyIdentifier,d));if(y===void 0&&(y=r[a+1]),y===void 0)throw new Error("Ran out of certificates");let g=y instanceof Y;if(y.isValidAtMoment()!==!0)throw new Error("Signing certificate is not valid now");if(y.keyUsage?.usages.has("digitalSignature")!==!0)throw new Error("Signing certificate keyUsage does not include digital signatures");if(y.basicConstraints?.ca!==!0)throw new Error("Signing certificate basicConstraints do not indicate a CA certificate");let{pathLength:u}=y.basicConstraints;if(u!==void 0&&u<a)throw new Error("Exceeded certificate path length");if(h.algorithm==="1.2.840.10045.4.3.2"||h.algorithm==="1.2.840.10045.4.3.3"){let m=h.algorithm==="1.2.840.10045.4.3.2"?"SHA-256":"SHA-384",w=y.publicKey.identifiers,S=w.includes("1.2.840.10045.3.1.7")?"P-256":w.includes("1.3.132.0.34")?"P-384":void 0;if(S===void 0)throw new Error("Unsupported signing key curve");let l=new H(h.signature);await at(l,y.publicKey.all,h.signedData,S,m)}else if(h.algorithm==="1.2.840.113549.1.1.11"){let m=await crypto.subtle.importKey("spki",y.publicKey.all,{name:"RSASSA-PKCS1-v1_5",hash:"SHA-256"},!1,["verify"]);if(await crypto.subtle.verify({name:"RSASSA-PKCS1-v1_5"},m,h.signature,h.signedData)!==!0)throw new Error("RSASSA_PKCS1-v1_5-SHA256 certificate verify failed")}else throw new Error("Unsupported signing algorithm");if(g){c=!0;break}}return c}var ce=new TextEncoder;async function Mt(r,e,t,n){let i=new H(await e());i.expectUint8(8,0);let[s]=i.expectLengthUint24(),[c,a]=i.expectLengthUint16(0);a()>0&&(i.expectUint16(0,0),i.expectUint16(0,0)),c(),s(),i.remaining()===0&&i.extend(await e()),i.expectUint8(11,0);let[o]=i.expectLengthUint24(0);i.expectUint8(0,0);let[h,d]=i.expectLengthUint24(0),y=[];for(;d()>0;){let[E]=i.expectLengthUint24(0),D=new Z(i);y.push(D),E();let[L,z]=i.expectLengthUint16(),ot=i.subarray(z());L()}if(h(),o(),y.length===0)throw new Error("No certificates supplied");let g=y[0],u=i.data.subarray(0,i.offset),m=p(n,u),w=await crypto.subtle.digest("SHA-256",m),S=new Uint8Array(w),l=p(ce.encode(" ".repeat(64)+"TLS 1.3, server CertificateVerify"),[0],S);i.remaining()===0&&i.extend(await e()),i.expectUint8(15,0);let[U]=i.expectLengthUint24(0),B=i.readUint16();if(B===1027){let[E]=i.expectLengthUint16();await at(i,g.publicKey.all,l,"P-256","SHA-256"),E()}else if(B===2052){let[E,D]=i.expectLengthUint16(),L=i.subarray(D());E();let z=await crypto.subtle.importKey("spki",g.publicKey.all,{name:"RSA-PSS",hash:"SHA-256"},!1,["verify"]);if(await crypto.subtle.verify({name:"RSA-PSS",saltLength:32},z,L,l)!==!0)throw new Error("RSA-PSS-RSAE-SHA256 certificate verify failed")}else throw new Error(`Unsupported certificate verify signature type 0x${N([B]).padStart(4,"0")}`);U();let K=i.data.subarray(0,i.offset),R=p(n,K),M=await A(t,"finished",new Uint8Array(0),32,256),j=await crypto.subtle.digest("SHA-256",R),T=await crypto.subtle.importKey("raw",M,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]),F=await crypto.subtle.sign("HMAC",T,j),O=new Uint8Array(F);i.remaining()===0&&i.extend(await e()),i.expectUint8(20,0);let[k,v]=i.expectLengthUint24(0),b=i.readBytes(v());if(k(),i.remaining()!==0)throw new Error("Unexpected extra bytes in server handshake");if(Q(b,O)!==!0)throw new Error("Invalid server verify hash");if(!await Ht(y,r))throw new Error("Validated certificate chain did not end in a trusted root");return i.data}async function Ft(r,e,t){let n=await crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey","deriveBits"]),i=await crypto.subtle.exportKey("raw",n.publicKey),s=new Uint8Array(32);crypto.getRandomValues(s);let a=ht(r,i,s).array();t(a);let o=await et(e,22);if(o===void 0)throw new Error("Connection closed while awaiting server hello");let h=new f(o.content),d=yt(h,s),y=await et(e,20);if(y===void 0)throw new Error("Connection closed awaiting server cipher change");let g=new f(y.content),[u]=g.expectLength(1);g.expectUint8(1,0),u();let m=a.subarray(5),w=o.content,S=p(m,w),l=await St(d,n.privateKey,S,256,16),U=await crypto.subtle.importKey("raw",l.serverHandshakeKey,{name:"AES-GCM"},!1,["decrypt"]),B=new q("decrypt",U,l.serverHandshakeIV),K=await crypto.subtle.importKey("raw",l.clientHandshakeKey,{name:"AES-GCM"},!1,["encrypt"]),R=new q("encrypt",K,l.clientHandshakeIV),j=await Mt(r,async()=>{let X=await dt(e,B,22);if(X===void 0)throw new Error("Premature end of encrypted server handshake");return X},l.serverSecret,S),T=new f(6);T.writeUint8(20,0),T.writeUint16(771,0);let F=T.writeLengthUint16();T.writeUint8(1,0),F();let O=T.array(),k=p(S,j),v=await crypto.subtle.digest("SHA-256",k),b=new Uint8Array(v),C=await A(l.clientSecret,"finished",new Uint8Array(0),32,256),I=await crypto.subtle.importKey("raw",C,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]),E=await crypto.subtle.sign("HMAC",I,b),D=new Uint8Array(E),L=new f(36);L.writeUint8(20,0);let z=L.writeLengthUint24(0);L.writeBytes(D),z();let ot=await lt(L.array(),R,22),W=await Ut(l.handshakeSecret,b,256,16),Qt=await crypto.subtle.importKey("raw",W.clientApplicationKey,{name:"AES-GCM"},!1,["encrypt"]),Vt=new q("encrypt",Qt,W.clientApplicationIV),jt=await crypto.subtle.importKey("raw",W.serverApplicationKey,{name:"AES-GCM"},!1,["decrypt"]),Ot=new q("decrypt",jt,W.serverApplicationIV),pt=!1;return[()=>dt(e,Ot),async X=>{let ft=await lt(X,Vt,23),qt=pt?p(...ft):p(O,...ot,...ft);t(qt),pt=!0}]}async function he(r,e){let t=await new Promise(h=>{let d=new WebSocket(`ws://localhost:9876/v1?address=${r}:${e}`);d.binaryType="arraybuffer",d.addEventListener("open",()=>h(d)),d.addEventListener("error",y=>{console.log("ws error:",y)}),d.addEventListener("close",()=>{})}),n=new _(t),i=Date.now(),[s,c]=await Ft(r,n.read.bind(n),t.send.bind(t)),a=new f(1024);a.writeUTF8String(`HEAD / HTTP/1.0\r
Host:${r}\r
\r
`),c(a.array());let o;do o=await s(),o&&ct(new TextDecoder().decode(o));while(o);ct(`time taken: ${Date.now()-i}ms`),window.dispatchEvent(new Event("tlsdone"))}he("google.com",443);
